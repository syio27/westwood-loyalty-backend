import{a as Se}from"./chunk-5ZEQ4OPA.js";import{a as Ee}from"./chunk-54FLRY4W.js";import{a as ke}from"./chunk-HODUG3LQ.js";import{a as Oe}from"./chunk-4W763UB3.js";import{a as we}from"./chunk-A4EUNQZ7.js";import{a as Re}from"./chunk-PXRPPFZK.js";import{a as Ce,b as Me}from"./chunk-JQSPPBHG.js";import"./chunk-GJSZY4YS.js";import{a as Pe}from"./chunk-QA7ABRFW.js";import"./chunk-3B24VZJ2.js";import{a as pe}from"./chunk-T6AS2VJX.js";import{a as ye}from"./chunk-3DDQSAFX.js";import{e as fe,g as he,m as xe,n as ve,o as be,u as _e}from"./chunk-OGICRJHM.js";import{n as ue,r as me}from"./chunk-S62YHFVO.js";import{a as ge}from"./chunk-CVI7F7U7.js";import{$ as M,$a as j,Aa as I,Ca as n,Da as i,Ea as h,Fa as Q,Ga as ee,Gb as se,Hb as ce,Ia as V,Ja as S,K as q,Ka as p,Lb as de,Sa as l,T as k,Ta as x,Ua as y,Va as te,Wa as ne,Z as T,_ as B,aa as w,ab as z,bb as H,cb as Y,d as W,db as G,gb as ie,k as _,ma as r,mb as oe,nb as ae,oa as J,pa as Z,q as X,tb as re,u as b,ua as f,ub as le,xa as $,ya as c,za as U}from"./chunk-SDVY3Z22.js";var De=()=>["/clients"],Te=()=>({sort:"totalAmount",order:"desc"}),K=a=>["/clients",a];function Be(a,u){a&1&&(n(0,"div",6),h(1,"app-loader",7),i()),a&2&&(r(),c("visible",!0)("overlay",!1))}function Ae(a,u){if(a&1&&(n(0,"div",87)(1,"div",88)(2,"div",89),M(),n(3,"svg",90),h(4,"path",91),i()(),w(),n(5,"div",92)(6,"span",93),l(7,"\u0411\u043E\u043D\u0443\u0441\u044B \u0438\u0441\u0442\u0435\u043A\u0430\u044E\u0442 \u0432 \u0431\u043B\u0438\u0436\u0430\u0439\u0448\u0438\u0435 7 \u0434\u043D\u0435\u0439"),i(),n(8,"span",94),l(9),i()(),n(10,"a",95),M(),n(11,"svg",90),h(12,"path",96),i()()()()),a&2){let e=p(2);r(9),ne("",e.expiringSoon.clientCount," ",e.expiringSoon.clientCount===1?"\u043A\u043B\u0438\u0435\u043D\u0442":e.expiringSoon.clientCount<5?"\u043A\u043B\u0438\u0435\u043D\u0442\u0430":"\u043A\u043B\u0438\u0435\u043D\u0442\u043E\u0432"," \xB7 ",e.formatAmount(e.expiringSoon.totalAmount)," \u20B8")}}function Fe(a,u){if(a&1&&(n(0,"span",102),l(1),i()),a&2){let e=p().$implicit;I("positive",e.changeType==="positive")("negative",e.changeType==="negative"),r(),x(e.change)}}function Le(a,u){if(a&1&&(n(0,"div",97)(1,"span",98),l(2),i(),n(3,"span",99)(4,"span",100),l(5),i(),f(6,Fe,2,5,"span",101),i()()),a&2){let e=u.$implicit;r(2),x(e.label),r(3),x(e.value),r(),c("ngIf",e.change)}}function $e(a,u){if(a&1&&(n(0,"span",102),l(1),i()),a&2){let e=p().$implicit;I("positive",e.changeType==="positive")("negative",e.changeType==="negative"),r(),x(e.change)}}function He(a,u){if(a&1&&(n(0,"div",97)(1,"span",98),l(2),i(),n(3,"span",99)(4,"span",100),l(5),i(),f(6,$e,2,5,"span",101),i()()),a&2){let e=u.$implicit;r(2),x(e.label),r(3),x(e.value),r(),c("ngIf",e.change)}}function ze(a,u){if(a&1&&(n(0,"span",105),M(),n(1,"svg",106),h(2,"circle",107)(3,"path",108),i()()),a&2){let e=p().$implicit;c("title",e.tooltip)}}function Ne(a,u){if(a&1&&(n(0,"div",103)(1,"span",98),l(2),f(3,ze,4,1,"span",104),i(),n(4,"span",100),l(5),i()()),a&2){let e=u.$implicit;c("title",e.tooltip),r(2),y(" ",e.label," "),r(),c("ngIf",e.tooltip),r(2),x(e.value)}}function Ue(a,u){if(a&1&&(n(0,"span",102),l(1),i()),a&2){let e=p().$implicit;I("positive",e.changeType==="positive")("negative",e.changeType==="negative"),r(),x(e.change)}}function Ve(a,u){if(a&1&&(n(0,"div",97)(1,"span",98),l(2),i(),n(3,"span",99)(4,"span",100),l(5),i(),f(6,Ue,2,5,"span",101),i()()),a&2){let e=u.$implicit;r(2),x(e.label),r(3),x(e.value),r(),c("ngIf",e.change)}}function je(a,u){if(a&1&&(n(0,"li",116)(1,"a",117)(2,"span",118),l(3),i(),n(4,"span",119),l(5),i()()()),a&2){let e=u.$implicit,t=p(3);r(),c("routerLink",z(3,K,e.clientId)),r(2),x(e.name),r(2),y("",t.formatAmount(e.totalSpent)," \u20B8")}}function Ye(a,u){if(a&1&&(n(0,"div",109)(1,"div",110)(2,"span",111),l(3,"\u0422\u043E\u043F \u043A\u043B\u0438\u0435\u043D\u0442\u043E\u0432"),i(),n(4,"a",112),M(),n(5,"svg",113),h(6,"path",96),i()()(),w(),n(7,"ul",114),f(8,je,6,5,"li",115),i()()),a&2){let e=p(2);r(4),c("routerLink",j(3,De))("queryParams",j(4,Te)),r(4),c("ngForOf",e.topCustomers.slice(0,3))}}function Ge(a,u){if(a&1&&(n(0,"span"),l(1),i()),a&2){let e=u.$implicit;r(),x(e)}}function Ke(a,u){if(a&1&&(n(0,"div",125)(1,"span",126),l(2,"\u0418\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u043E:"),i(),n(3,"span",131),l(4),i()()),a&2){let e=p().$implicit,t=p(2);r(4),y("-",t.formatAmount(e.bonusUsed),"")}}function We(a,u){if(a&1&&(n(0,"div",120),h(1,"div",121),n(2,"div",122)(3,"div",123),l(4),i(),n(5,"div",124)(6,"div",125)(7,"span",126),l(8,"\u0412\u044B\u0440\u0443\u0447\u043A\u0430:"),i(),n(9,"span",127),l(10),i()(),n(11,"div",125)(12,"span",126),l(13,"\u0422\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u0439:"),i(),n(14,"span",128),l(15),i()(),n(16,"div",125)(17,"span",126),l(18,"\u041D\u0430\u0447\u0438\u0441\u043B\u0435\u043D\u043E:"),i(),n(19,"span",129),l(20),i()(),f(21,Ke,5,1,"div",130),i()()()),a&2){let e=u.$implicit,t=u.last,o=p(2);U("left",e.x/600*100,"%")("top",e.y/300*100,"%"),r(),I("last-point",t),r(3),te("",e.day," ",o.getMonthName(),""),r(6),y("",o.formatAmount(e.revenue)," \u20B8"),r(5),x(e.transactions),r(5),y("+",o.formatAmount(e.bonusEarned),""),r(),c("ngIf",e.bonusUsed>0)}}function Xe(a,u){if(a&1&&(n(0,"span"),l(1),i()),a&2){let e=u.$implicit,t=u.index,o=p(2);U("left",o.getXAxisLabelPositions()[t]/600*100,"%"),r(),x(e)}}function qe(a,u){if(a&1&&(n(0,"div",132)(1,"h3",47),l(2,"\u041F\u0440\u043E\u0434\u0430\u0436\u0438"),i(),n(3,"div",133),M(),n(4,"svg",134),h(5,"circle",135)(6,"circle",136)(7,"circle",137),i()(),w(),n(8,"div",138)(9,"div",139),h(10,"span",140),n(11,"div")(12,"div",141),l(13,"\u0421 \u0431\u043E\u043D\u0443\u0441\u0430\u043C\u0438"),i(),n(14,"div",142),l(15),H(16,"number"),i(),n(17,"div",143),l(18),H(19,"number"),i()()(),n(20,"div",139),h(21,"span",144),n(22,"div")(23,"div",141),l(24,"\u0411\u0435\u0437 \u0431\u043E\u043D\u0443\u0441\u043E\u0432"),i(),n(25,"div",142),l(26),H(27,"number"),i(),n(28,"div",143),l(29),H(30,"number"),i()()()()()),a&2){let e=p(2);r(6),$("stroke-dasharray",e.getDonutLoyaltyDash()),r(),$("stroke-dasharray",e.getDonutNonLoyaltyDash())("stroke-dashoffset",e.getDonutNonLoyaltyOffset()),r(8),y("",G(16,7,e.salesByLoyalty.loyaltyPercent,"1.0-0"),"%"),r(3),x(Y(19,10,e.salesByLoyalty.loyaltyCount)),r(8),y("",G(27,12,e.salesByLoyalty.nonLoyaltyPercent,"1.0-0"),"%"),r(3),x(Y(30,15,e.salesByLoyalty.nonLoyaltyCount))}}function Je(a,u){if(a&1&&(n(0,"app-badge",183),l(1),i()),a&2){let e=p().$implicit,t=p(2);r(),y(" +",t.formatAmount(e.bonusEarned)," ")}}function Ze(a,u){if(a&1&&(n(0,"app-badge",184),l(1),i()),a&2){let e=p().$implicit,t=p(2);r(),y(" -",t.formatAmount(e.bonusUsed)," ")}}function Qe(a,u){if(a&1&&(n(0,"app-badge",185),l(1),i()),a&2){let e=p().$implicit,t=p(2);r(),y(" -",t.formatAmount(e.bonusRevoked)," ")}}function et(a,u){a&1&&(n(0,"span",186),l(1,"\u2014"),i())}function tt(a,u){if(a&1&&(n(0,"div",198),l(1),i()),a&2){let e=p(2).$implicit;r(),y(" ",e.refundReason," ")}}function nt(a,u){a&1&&(n(0,"div",199),l(1," \u041D\u0435\u0442 \u043F\u0440\u0438\u0447\u0438\u043D\u044B \u0432\u043E\u0437\u0432\u0440\u0430\u0442\u0430 "),i())}function it(a,u){if(a&1&&(n(0,"div",200),l(1),i()),a&2){let e=p(2).$implicit;r(),y(" ",e.initiatedBy," ")}}function ot(a,u){a&1&&(n(0,"div",201),l(1," \u041D\u0435 \u0443\u043A\u0430\u0437\u0430\u043D "),i())}function at(a,u){if(a&1&&(n(0,"tr",187)(1,"td",188)(2,"div",189)(3,"div",190)(4,"div",191)(5,"span",192),l(6,"\u041F\u0440\u0438\u0447\u0438\u043D\u0430 \u0432\u043E\u0437\u0432\u0440\u0430\u0442\u0430:"),i(),f(7,tt,2,1,"div",193)(8,nt,2,0,"div",194),i(),n(9,"div",195)(10,"span",192),l(11,"\u0418\u043D\u0438\u0446\u0438\u0430\u0442\u043E\u0440 \u043F\u043B\u0430\u0442\u0435\u0436\u0430:"),i(),f(12,it,2,1,"div",196)(13,ot,2,0,"div",197),i()()()()()),a&2){let e=p().$implicit;r(7),c("ngIf",e.refundReason),r(),c("ngIf",!e.refundReason),r(4),c("ngIf",e.initiatedBy),r(),c("ngIf",!e.initiatedBy)}}function rt(a,u){if(a&1){let e=V();Q(0),n(1,"tr",145)(2,"td",146)(3,"span",147),S("click",function(){let o=T(e).$implicit,s=p(2);return B(s.openPaymentView(o.id))}),l(4),i()(),n(5,"td",148)(6,"div",149)(7,"div",150),l(8),i(),n(9,"div",151)(10,"a",152)(11,"span",153),l(12),i()(),n(13,"span",154),l(14),i()()()(),n(15,"td",155)(16,"span",156),l(17),i()(),n(18,"td",157)(19,"div",158),f(20,Je,2,1,"app-badge",159)(21,Ze,2,1,"app-badge",160)(22,Qe,2,1,"app-badge",161)(23,et,2,0,"span",162),i()(),n(24,"td",163),h(25,"app-badge",164),i(),n(26,"td",165)(27,"app-badge",166),l(28),i()(),n(29,"td",167)(30,"div",168)(31,"span",169),l(32),i(),n(33,"span",170),l(34),i()()(),n(35,"td",171)(36,"div",172)(37,"a",173)(38,"app-icon-button",174),M(),n(39,"svg",175),h(40,"path",176)(41,"circle",177),i()()(),w(),n(42,"app-icon-button",178),S("onClick",function(){let o=T(e).$implicit,s=p(2);return B(s.openRefundModal(o))}),M(),n(43,"svg",175),h(44,"path",179),i()(),w(),n(45,"app-icon-button",180),S("onClick",function(){let o=T(e).$implicit,s=p(2);return B(s.toggleRowExpansion(o.id))}),M(),n(46,"svg",90),h(47,"path",181),i()()()()(),f(48,at,14,4,"tr",182),ee()}if(a&2){let e=u.$implicit,t=p(2);r(),I("expanded",t.isRowExpanded(e.id)),r(3),y("#",t.formatPaymentId(e.id),""),r(4),y(" ",t.getInitials(e.clientName)," "),r(2),c("routerLink",z(24,K,e.clientId)),r(2),x(e.clientName),r(2),x(e.clientPhone),r(3),y("",t.formatAmount(e.amount)," \u20B8"),r(3),c("ngIf",e.bonusEarned>0),r(),c("ngIf",e.bonusUsed>0),r(),c("ngIf",e.bonusRevoked>0),r(),c("ngIf",e.bonusEarned===0&&e.bonusUsed===0&&e.bonusRevoked===0),r(2),c("paymentMethod",t.getPaymentMethodForBadge(e.paymentMethod)),r(2),c("badgeType",e.isRefund?"refund":"payment")("icon",e.isRefund?"refund":"payment"),r(),y(" ",e.isRefund?"\u0412\u043E\u0437\u0432\u0440\u0430\u0442":"\u041E\u043F\u043B\u0430\u0447\u0435\u043D\u043E"," "),r(4),x(e.date),r(2),x(e.time),r(3),c("routerLink",z(26,K,e.clientId)),r(5),c("disabled",e.isRefund),r(3),c("tooltip",t.isRowExpanded(e.id)?"\u0421\u043A\u0440\u044B\u0442\u044C \u0434\u0435\u0442\u0430\u043B\u0438":"\u041F\u043E\u043A\u0430\u0437\u0430\u0442\u044C \u0434\u0435\u0442\u0430\u043B\u0438"),r(),I("rotated",t.isRowExpanded(e.id)),r(2),c("ngIf",t.isRowExpanded(e.id))}}function lt(a,u){if(a&1){let e=V();n(0,"div")(1,"div",8)(2,"app-button",9),S("onClick",function(){T(e);let o=p();return B(o.openTransactionModal())}),M(),n(3,"svg",10),h(4,"path",11),i(),w(),n(5,"span",12),l(6,"\u041D\u043E\u0432\u0430\u044F \u0442\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u044F"),i()()(),f(7,Ae,13,3,"div",13),n(8,"div",14)(9,"section",15)(10,"div",16)(11,"div",17),M(),n(12,"svg",18),h(13,"path",19),i()(),w(),n(14,"h3",20),l(15,"\u041F\u043B\u0430\u0442\u0435\u0436\u0438"),i()(),n(16,"div",21),f(17,Le,7,3,"div",22),i()(),n(18,"section",15)(19,"div",16)(20,"div",23),M(),n(21,"svg",24),h(22,"path",25),i()(),w(),n(23,"h3",20),l(24,"\u0411\u043E\u043D\u0443\u0441\u044B"),i()(),n(25,"div",21),f(26,He,7,3,"div",22),i()(),n(27,"section",15)(28,"div",26)(29,"div",27),M(),n(30,"svg",18),h(31,"path",28)(32,"path",29)(33,"path",30)(34,"path",31),i()(),w(),n(35,"h3",20),l(36,"KPI"),i(),n(37,"div",32)(38,"select",33),S("ngModelChange",function(o){T(e);let s=p();return B(s.onKpiPeriodChange(o))}),n(39,"option",34),l(40,"\u0417\u0430 \u043C\u0435\u0441\u044F\u0446"),i(),n(41,"option",35),l(42,"\u0417\u0430 3 \u043C\u0435\u0441\u044F\u0446\u0430"),i(),n(43,"option",36),l(44,"\u0417\u0430 6 \u043C\u0435\u0441\u044F\u0446\u0435\u0432"),i(),n(45,"option",37),l(46,"\u0417\u0430 \u0433\u043E\u0434"),i(),n(47,"option",38),l(48,"\u0417\u0430 \u0432\u0441\u0435 \u0432\u0440\u0435\u043C\u044F"),i()()()(),n(49,"div",21),f(50,Ne,6,4,"div",39),i()(),n(51,"section",15)(52,"div",16)(53,"div",40),M(),n(54,"svg",18),h(55,"path",41)(56,"circle",42)(57,"path",43),i()(),w(),n(58,"h3",20),l(59,"\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0438"),i()(),n(60,"div",21),f(61,Ve,7,3,"div",22),i(),f(62,Ye,9,5,"div",44),i()(),n(63,"div",45)(64,"div",46)(65,"h3",47),l(66,"\u0412\u044B\u0440\u0443\u0447\u043A\u0430 \u0437\u0430 \u043C\u0435\u0441\u044F\u0446"),i(),n(67,"div",48)(68,"div",49)(69,"div",50),f(70,Ge,2,1,"span",51),i()(),n(71,"div",52)(72,"div",53),M(),n(73,"svg",54)(74,"defs")(75,"linearGradient",55),h(76,"stop",56)(77,"stop",57),i()(),n(78,"g",58),h(79,"line",59)(80,"line",60)(81,"line",61)(82,"line",62)(83,"line",63),i(),h(84,"path",64)(85,"path",65),i(),w(),n(86,"div",66),f(87,We,22,12,"div",67),i()(),n(88,"div",68)(89,"span",69),l(90,"\u0414\u043D\u0438"),i(),n(91,"div",70),f(92,Xe,2,3,"span",71),i()()()()(),f(93,qe,31,17,"div",72),i(),n(94,"div",73)(95,"div",74)(96,"h3",75),l(97,"\u041F\u043E\u0441\u043B\u0435\u0434\u043D\u0438\u0435 \u043E\u043F\u0435\u0440\u0430\u0446\u0438\u0438"),i(),n(98,"a",76),l(99,"\u0421\u043C\u043E\u0442\u0440\u0435\u0442\u044C \u0432\u0441\u0435 \u2192"),i()(),n(100,"div",77)(101,"table",78)(102,"thead")(103,"tr")(104,"th",79),l(105,"ID \u043F\u043B\u0430\u0442\u0435\u0436\u0430"),i(),n(106,"th",80),l(107,"\u041A\u043B\u0438\u0435\u043D\u0442"),i(),n(108,"th",81),l(109,"\u0421\u0443\u043C\u043C\u0430"),i(),n(110,"th",82),l(111,"\u0411\u043E\u043D\u0443\u0441\u044B"),i(),n(112,"th",83),l(113,"\u0421\u043F\u043E\u0441\u043E\u0431 \u043E\u043F\u043B\u0430\u0442\u044B"),i(),n(114,"th",84),l(115,"\u0421\u0442\u0430\u0442\u0443\u0441"),i(),n(116,"th",85),l(117,"\u0414\u0430\u0442\u0430 \u0438 \u0432\u0440\u0435\u043C\u044F"),i(),n(118,"th",86),l(119,"\u0414\u0435\u0439\u0441\u0442\u0432\u0438\u044F"),i()()(),n(120,"tbody"),f(121,rt,49,28,"ng-container",51),i()()()()()}if(a&2){let e=p();r(7),c("ngIf",e.expiringSoon&&e.expiringSoon.clientCount>0),r(10),c("ngForOf",e.paymentCards),r(9),c("ngForOf",e.bonusCards),r(12),c("ngModel",e.kpiPeriod),r(12),c("ngForOf",e.kpiMetricCards),r(11),c("ngForOf",e.userCards),r(),c("ngIf",e.topCustomers.length>0),r(8),c("ngForOf",e.getYAxisLabels()),r(14),$("d",e.getAreaPath()),r(),$("d",e.getChartPath()),r(2),c("ngForOf",e.getChartData()),r(5),c("ngForOf",e.getXAxisLabels()),r(),c("ngIf",e.salesByLoyalty),r(28),c("ngForOf",e.recentPayments)}}var Dt=(()=>{class a{store;user$;pageHeaderService=k(Pe);transactionModalService=k(Ce);analyticsService=k(we);bonusesService=k(ke);paymentsService=k(Me);toastService=k(pe);cdr=k(ie);showRefundModal=!1;selectedPaymentForRefund=null;showPaymentViewModal=!1;selectedPaymentTxId=null;selectedPaymentSearchResult=null;isProcessingRefund=!1;expandedRows=new Set;isLoading=!0;isChartLoading=!0;isLoadingPayments=!1;paymentCards=[];bonusCards=[];kpiMetricCards=[];userCards=[];topCustomers=[];bonusesInCirculationAmount=null;salesByLoyalty=null;kpiPeriod="1m";chartYAxisMax=3e4;expiringSoon=null;recentPayments=[];destroy$=new W;router=k(se);constructor(e){this.store=e,this.user$=this.store.select(me)}ngOnInit(){this.pageHeaderService.setPageHeader("\u0411\u044B\u0441\u0442\u0440\u044B\u0439 \u041E\u0431\u0437\u043E\u0440",[{label:"\u0413\u043B\u0430\u0432\u043D\u0430\u044F"}]),this.loadAnalyticsData(),this.loadChartData(),this.loadRecentPayments(),this.loadExpiringBonuses(),this.transactionModalService.transactionComplete$.pipe(q(this.destroy$)).subscribe(()=>{let e=this.router.url;(e==="/home"||e.startsWith("/home"))&&(this.loadAnalyticsData(),this.loadChartData(),this.loadRecentPayments(),this.loadExpiringBonuses())})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}loadAnalyticsData(){this.isLoading=!0;let{from:e,to:t}=this.getKpiPeriodRange();X({monthlyRevenue:this.analyticsService.getMonthlyRevenue().pipe(b(()=>_({revenue:0,changePercent:0,amount:0}))),dailyRevenue:this.analyticsService.getDailyRevenue().pipe(b(()=>_({revenue:0,changePercent:0,amount:0}))),dailyTransactions:this.analyticsService.getDailyTransactions().pipe(b(()=>_({count:0,changeAbsolute:0}))),newClients:this.analyticsService.getNewClients("DAILY").pipe(b(()=>_({count:0,changeAbsolute:0,type:"NEW",period:"DAILY"}))),averageCheck:this.analyticsService.getAverageCheck("MONTHLY").pipe(b(()=>_({averageCheck:0,changePercent:0,amount:0}))),bonusesAccrued:this.analyticsService.getBonusesAccrued("MONTHLY").pipe(b(()=>_({amount:0,changePercentage:0}))),dailyRefunds:this.analyticsService.getDailyRefunds().pipe(b(()=>_({count:0,changeAbsolute:0}))),activeClients:this.analyticsService.getActiveClients().pipe(b(()=>_({count:0,changeAbsolute:0}))),kpiDashboard:this.analyticsService.getKpiDashboard(e,t).pipe(b(()=>_(null))),topCustomers:this.analyticsService.getTopCustomers().pipe(b(()=>_([]))),bonusesInCirculation:this.analyticsService.getBonusesInCirculation().pipe(b(()=>_({amount:0}))),salesByLoyalty:this.analyticsService.getSalesByLoyalty().pipe(b(()=>_({loyaltyCount:0,nonLoyaltyCount:0,loyaltyPercent:0,nonLoyaltyPercent:100})))}).subscribe({next:o=>{this.topCustomers=o.topCustomers||[],this.bonusesInCirculationAmount=o.bonusesInCirculation?.amount??0,this.salesByLoyalty=o.salesByLoyalty??null,this.updateKpiCards(o),this.isLoading=!1,this.cdr.detectChanges()},error:o=>{console.error("Error loading analytics data:",o),this.isLoading=!1,this.bonusesInCirculationAmount=0,this.salesByLoyalty=null,this.updateKpiCards({monthlyRevenue:{amount:0},dailyRevenue:{amount:0},dailyTransactions:{count:0},newClients:{count:0,changeAbsolute:0,type:"NEW",period:"DAILY"},averageCheck:{amount:0},bonusesAccrued:{amount:0},dailyRefunds:{count:0},activeClients:{count:0},kpiDashboard:null,topCustomers:[],bonusesInCirculation:{amount:0},salesByLoyalty:{loyaltyCount:0,nonLoyaltyCount:0,loyaltyPercent:0,nonLoyaltyPercent:100}}),this.cdr.detectChanges()}})}loadExpiringBonuses(){this.bonusesService.getBonusesExpiringSoon().pipe(b(e=>(console.error("Error loading expiring bonuses:",e),_({clientCount:0,totalAmount:0,clients:[]})))).subscribe({next:e=>{this.expiringSoon=e.clientCount>0?e:null,this.cdr.markForCheck()}})}loadRecentPayments(){this.isLoadingPayments=!0,this.paymentsService.searchPayments({page:0,size:5,sortBy:"date",sortDirection:"DESC"}).pipe(b(e=>(console.error("Error loading recent payments:",e),_({content:[],totalElements:0,totalPages:0,page:0,size:5})))).subscribe({next:e=>{console.log("Recent payments received:",e),this.recentPayments=e.content.map(t=>this.convertPaymentToRecentPayment(t)),this.isLoadingPayments=!1,this.cdr.detectChanges()},error:e=>{console.error("Error in recent payments subscription:",e),this.isLoadingPayments=!1,this.cdr.detectChanges()}})}convertPaymentToRecentPayment(e){if(!e.createdAt){let g=new Date;return{id:e.txId||"",clientId:e.clientId||"",clientName:e.clientName||"\u2014",clientPhone:e.clientPhone||"\u2014",amount:e.amount||0,bonusEarned:e.bonusGranted||0,bonusUsed:e.bonusUsed||0,bonusRevoked:e.bonusRevoked||0,paymentMethod:"card",isRefund:e.status==="REFUNDED"||e.refundedPaymentTxId!==null,date:g.toLocaleDateString("ru-RU"),time:g.toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"}),initiatedBy:e.initiatedBy||null,refundReason:e.refundReason||null}}let t=new Date(e.createdAt);if(isNaN(t.getTime())){let g=new Date;t.setTime(g.getTime())}let o=String(t.getDate()).padStart(2,"0"),s=String(t.getMonth()+1).padStart(2,"0"),d=t.getFullYear(),m=`${o}.${s}.${d}`,C=String(t.getHours()).padStart(2,"0"),v=String(t.getMinutes()).padStart(2,"0"),E=`${C}:${v}`,P="card";if(e.paymentMethod){let g=e.paymentMethod.toLowerCase();g.includes("cash")||g.includes("\u043D\u0430\u043B\u0438\u0447")?P="cash":g.includes("transfer")||g.includes("\u043F\u0435\u0440\u0435\u0432\u043E\u0434")?P="transfer":P="card"}return{id:e.txId||"",clientId:e.clientId||"",clientName:e.clientName||"\u2014",clientPhone:e.clientPhone||"\u2014",amount:e.amount||0,bonusEarned:e.bonusGranted||0,bonusUsed:e.bonusUsed||0,bonusRevoked:e.bonusRevoked||0,paymentMethod:P,isRefund:e.status==="REFUNDED"||e.refundedPaymentTxId!==null,date:m,time:E,initiatedBy:e.initiatedBy||null,refundReason:e.refundReason||null}}loadChartData(){this.isChartLoading=!0;let e=new Date,t=e.getFullYear(),o=e.getMonth()+1;console.log("Loading chart data for:",t,o),this.analyticsService.getMonthlyRevenueChart(t,o).pipe(b(s=>{console.error("Error loading chart data:",s),console.error("Error status:",s.status);let d=t,m=o-1;return m<1&&(m=12,d=t-1),console.log("Trying fallback date:",d,m),this.analyticsService.getMonthlyRevenueChart(d,m).pipe(b(C=>(console.error("Fallback also failed:",C),_({dailyData:[],year:d,month:m}))))})).subscribe({next:s=>{console.log("Chart data received:",s),console.log("Chart data array length:",s.dailyData?.length);let d=s.dailyData||s.data||[];this.updateChartData(d),this.isChartLoading=!1,this.cdr.detectChanges()},error:s=>{console.error("Subscription error:",s),this.isChartLoading=!1,this.cdr.detectChanges()}})}updateKpiCards(e){let t=e.kpiDashboard,o=e.monthlyRevenue?.amount??e.monthlyRevenue?.revenue??0,s=e.monthlyRevenue?.changePercentage??e.monthlyRevenue?.changePercent,d=e.dailyRevenue?.amount??e.dailyRevenue?.revenue??0,m=e.dailyRevenue?.changePercentage??e.dailyRevenue?.changePercent,C=e.averageCheck?.amount??e.averageCheck?.averageCheck??0,v=e.averageCheck?.changePercentage??e.averageCheck?.changePercent,E=e.bonusesAccrued?.amount??e.bonusesAccrued?.count??0,P=e.bonusesAccrued?.changePercentage??e.bonusesAccrued?.changePercent;this.paymentCards=[{iconId:"month",iconBg:"linear-gradient(135deg, #f0fdf4, #dcfce7)",value:this.formatCurrency(o),label:"\u0412\u044B\u0440\u0443\u0447\u043A\u0430 \u0437\u0430 \u043C\u0435\u0441\u044F\u0446",change:s!=null?`${s>0?"+":""}${s.toFixed(0)}%`:void 0,changeType:s!=null&&s>=0?"positive":"negative"},{iconId:"today",iconBg:"linear-gradient(135deg, #f0fdf4, #dcfce7)",value:this.formatCurrency(d),label:"\u0412\u044B\u0440\u0443\u0447\u043A\u0430 \u0437\u0430 \u0441\u0435\u0433\u043E\u0434\u043D\u044F",change:m!=null?`${m>0?"+":""}${m.toFixed(0)}%`:void 0,changeType:m!=null&&m>=0?"positive":"negative"},{iconId:"average",iconBg:"linear-gradient(135deg, #f0fdf4, #dcfce7)",value:this.formatCurrency(C),label:"\u0421\u0440\u0435\u0434\u043D\u0438\u0439 \u0447\u0435\u043A",change:v!=null?`${v>0?"+":""}${v.toFixed(0)}%`:void 0,changeType:v!=null&&v>=0?"positive":"negative"},{iconId:"transactions",iconBg:"linear-gradient(135deg, #f0fdf4, #dcfce7)",value:(e.dailyTransactions?.count??0).toString(),label:"\u041A\u043E\u043B-\u0432\u043E \u0442\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u0439",change:e.dailyTransactions?.changeAbsolute!=null?`${e.dailyTransactions.changeAbsolute>0?"+":""}${e.dailyTransactions.changeAbsolute}`:void 0,changeType:e.dailyTransactions?.changeAbsolute!=null&&e.dailyTransactions.changeAbsolute>=0?"positive":"negative"},{iconId:"average",iconBg:"linear-gradient(135deg, #fef3c7, #fde68a)",value:t?.uplift?.avgCheckWithBonus!=null?this.formatCurrency(Number(t.uplift.avgCheckWithBonus)):"\u2014",label:"\u0421\u0440\u0435\u0434\u043D\u0438\u0439 \u0447\u0435\u043A \u0441 \u0431\u043E\u043D\u0443\u0441\u0430\u043C\u0438"},{iconId:"average",iconBg:"linear-gradient(135deg, #e0f2fe, #bae6fd)",value:t?.uplift?.avgCheckRegular!=null?this.formatCurrency(Number(t.uplift.avgCheckRegular)):"\u2014",label:"\u0421\u0440\u0435\u0434\u043D\u0438\u0439 \u0447\u0435\u043A \u0431\u0435\u0437 \u0431\u043E\u043D\u0443\u0441\u043E\u0432"}];let g=e.bonusesInCirculation?.amount??this.bonusesInCirculationAmount??0;this.bonusCards=[{iconId:"bonus",iconBg:"linear-gradient(135deg, #f0fdf4, #dcfce7)",value:this.formatCurrency(g),label:"\u0411\u043E\u043D\u0443\u0441\u044B \u0432 \u043E\u0431\u043E\u0440\u043E\u0442\u0435"},{iconId:"bonus",iconBg:"linear-gradient(135deg, #f0fdf4, #dcfce7)",value:this.formatCurrency(E),label:"\u041D\u0430\u0447\u0438\u0441\u043B\u0435\u043D\u043D\u044B\u0435 \u0431\u043E\u043D\u0443\u0441\u044B",change:P!=null?`${P>0?"+":""}${P.toFixed(0)}%`:void 0,changeType:P!=null&&P>=0?"positive":"negative"},{iconId:"refunds",iconBg:"linear-gradient(135deg, #fef2f2, #fee2e2)",value:(e.dailyRefunds?.count??0).toString(),label:"\u0412\u043E\u0437\u0432\u0440\u0430\u0442\u044B",change:e.dailyRefunds?.changeAbsolute!=null?`${e.dailyRefunds.changeAbsolute>0?"+":""}${e.dailyRefunds.changeAbsolute}`:void 0,changeType:e.dailyRefunds?.changeAbsolute!=null&&e.dailyRefunds.changeAbsolute>=0?"positive":"negative"},{iconId:"bonus",iconBg:"linear-gradient(135deg, #fef3c7, #fde68a)",value:t?.efficiency?.burnedAmount!=null?this.formatCurrency(Number(t.efficiency.burnedAmount)):"0 \u20B8",label:"\u0421\u0433\u043E\u0440\u0435\u0432\u0448\u0438\u0435 \u0431\u043E\u043D\u0443\u0441\u044B (\u0441\u0443\u043C\u043C\u0430)"}];let R=t?.retention?.retentionRate!=null?Number(t.retention.retentionRate).toFixed(1):"\u2014",O=t?.efficiency?.redemptionRate!=null?Number(t.efficiency.redemptionRate).toFixed(1)+"%":"\u2014",A=t?.efficiency?.effectiveDiscount!=null?Number(t.efficiency.effectiveDiscount).toFixed(1)+"%":"\u2014",D=t?.efficiency?.burnRate!=null?Number(t.efficiency.burnRate).toFixed(1)+"%":"\u2014",F=t?.uplift?.aovUplift!=null?Number(t.uplift.aovUplift).toFixed(1)+"%":"\u2014",L=t?.revenue?.incrementalRevenuePercentage!=null?Number(t.revenue.incrementalRevenuePercentage).toFixed(1)+"%":"\u2014";this.kpiMetricCards=[{iconId:"average",iconBg:"linear-gradient(135deg, #e0e7ff, #c7d2fe)",value:R+(R!=="\u2014"?"%":""),label:"Retention",tooltip:"\u0414\u043E\u043B\u044F \u043A\u043B\u0438\u0435\u043D\u0442\u043E\u0432, \u0441\u043E\u0432\u0435\u0440\u0448\u0438\u0432\u0448\u0438\u0445 2 \u0438 \u0431\u043E\u043B\u0435\u0435 \u043F\u043E\u043A\u0443\u043F\u043E\u043A \u0432 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u043C \u043F\u0435\u0440\u0438\u043E\u0434\u0435, \u043E\u0442 \u043E\u0431\u0449\u0435\u0433\u043E \u0447\u0438\u0441\u043B\u0430 \u0430\u043A\u0442\u0438\u0432\u043D\u044B\u0445 \u043A\u043B\u0438\u0435\u043D\u0442\u043E\u0432. \u041F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u0442 \u0443\u0434\u0435\u0440\u0436\u0430\u043D\u0438\u0435."},{iconId:"average",iconBg:"linear-gradient(135deg, #e0e7ff, #c7d2fe)",value:O,label:"Redemption rate",tooltip:"\u0414\u043E\u043B\u044F \u043D\u0430\u0447\u0438\u0441\u043B\u0435\u043D\u043D\u044B\u0445 \u0431\u043E\u043D\u0443\u0441\u043E\u0432, \u043A\u043E\u0442\u043E\u0440\u0443\u044E \u043A\u043B\u0438\u0435\u043D\u0442\u044B \u043F\u043E\u0442\u0440\u0430\u0442\u0438\u043B\u0438 \u0432 \u043F\u0435\u0440\u0438\u043E\u0434\u0435. \u041F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u0442, \u043D\u0430\u0441\u043A\u043E\u043B\u044C\u043A\u043E \u0430\u043A\u0442\u0438\u0432\u043D\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u044E\u0442 \u0431\u043E\u043D\u0443\u0441\u044B."},{iconId:"average",iconBg:"linear-gradient(135deg, #e0e7ff, #c7d2fe)",value:A,label:"Effective discount",tooltip:"\u0421\u0440\u0435\u0434\u043D\u0438\u0439 \u0444\u0430\u043A\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u0441\u043A\u0438\u0434\u043E\u0447\u043D\u044B\u0439 \u043F\u0440\u043E\u0446\u0435\u043D\u0442 \u043F\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u043C \u0431\u043E\u043D\u0443\u0441\u0430\u043C \u043E\u0442\u043D\u043E\u0441\u0438\u0442\u0435\u043B\u044C\u043D\u043E \u0432\u044B\u0440\u0443\u0447\u043A\u0438 \u0432 \u043F\u0435\u0440\u0438\u043E\u0434\u0435."},{iconId:"average",iconBg:"linear-gradient(135deg, #e0e7ff, #c7d2fe)",value:D,label:"Burn rate",tooltip:"\u0414\u043E\u043B\u044F \u043D\u0430\u0447\u0438\u0441\u043B\u0435\u043D\u043D\u044B\u0445 \u0437\u0430 \u043F\u043E\u0441\u043B\u0435\u0434\u043D\u0438\u0435 12 \u043C\u0435\u0441\u044F\u0446\u0435\u0432 \u0431\u043E\u043D\u0443\u0441\u043E\u0432, \u043A\u043E\u0442\u043E\u0440\u0430\u044F \u0441\u0433\u043E\u0440\u0435\u043B\u0430 (\u0438\u0441\u0442\u0435\u043A \u0441\u0440\u043E\u043A). \u041F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u0442 \u043F\u043E\u0442\u0435\u0440\u0438 \u043E\u0442 \u043D\u0435\u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0438\u044F."},{iconId:"average",iconBg:"linear-gradient(135deg, #e0e7ff, #c7d2fe)",value:F,label:"AOV uplift",tooltip:"\u0420\u0430\u0437\u043D\u0438\u0446\u0430 \u0441\u0440\u0435\u0434\u043D\u0435\u0433\u043E \u0447\u0435\u043A\u0430 \u043C\u0435\u0436\u0434\u0443 \u043F\u043B\u0430\u0442\u0435\u0436\u0430\u043C\u0438 \u0441 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0438\u0435\u043C \u0431\u043E\u043D\u0443\u0441\u043E\u0432 \u0438 \u0431\u0435\u0437. \u041F\u043E\u043B\u043E\u0436\u0438\u0442\u0435\u043B\u044C\u043D\u044B\u0439 uplift \u2014 \u043A\u043B\u0438\u0435\u043D\u0442\u044B \u0441 \u0431\u043E\u043D\u0443\u0441\u0430\u043C\u0438 \u0442\u0440\u0430\u0442\u044F\u0442 \u0431\u043E\u043B\u044C\u0448\u0435."},{iconId:"average",iconBg:"linear-gradient(135deg, #e0e7ff, #c7d2fe)",value:L,label:"Incremental revenue %",tooltip:"\u0414\u043E\u043B\u044F \u0434\u043E\u043F\u043E\u043B\u043D\u0438\u0442\u0435\u043B\u044C\u043D\u043E\u0439 \u0432\u044B\u0440\u0443\u0447\u043A\u0438 \u043E\u0442 \u043F\u043B\u0430\u0442\u0435\u0436\u0435\u0439 \u0441 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0438\u0435\u043C \u0431\u043E\u043D\u0443\u0441\u043E\u0432 \u0432 \u043E\u0431\u0449\u0435\u0439 \u0432\u044B\u0440\u0443\u0447\u043A\u0435 \u043F\u0435\u0440\u0438\u043E\u0434\u0430."}];let N=t?.retention?.returningClientsCount??0;this.userCards=[{iconId:"clients",iconBg:"linear-gradient(135deg, #f0fdf4, #dcfce7)",value:(e.newClients?.count??0).toString(),label:"\u041D\u043E\u0432\u044B\u0435 \u043A\u043B\u0438\u0435\u043D\u0442\u044B",change:e.newClients?.changeAbsolute!=null?`${e.newClients.changeAbsolute>0?"+":""}${e.newClients.changeAbsolute}`:void 0,changeType:e.newClients?.changeAbsolute!=null&&e.newClients.changeAbsolute>=0?"positive":"negative"},{iconId:"clients",iconBg:"linear-gradient(135deg, #f0fdf4, #dcfce7)",value:String(N),label:"\u0412\u0435\u0440\u043D\u0443\u0432\u0448\u0438\u0435\u0441\u044F \u043A\u043B\u0438\u0435\u043D\u0442\u044B"},{iconId:"clients",iconBg:"linear-gradient(135deg, #f0fdf4, #dcfce7)",value:(e.activeClients?.count??0).toString(),label:"\u0410\u043A\u0442\u0438\u0432\u043D\u044B\u0435 \u043A\u043B\u0438\u0435\u043D\u0442\u044B",change:e.activeClients?.changeAbsolute!=null?`${e.activeClients.changeAbsolute>0?"+":""}${e.activeClients.changeAbsolute}`:void 0,changeType:e.activeClients?.changeAbsolute!=null&&e.activeClients.changeAbsolute>=0?"positive":"negative"}]}updateChartData(e){if(console.log("Updating chart data with:",e),!e||e.length===0){console.log("Chart data is empty, clearing cache"),this._chartDataCache=null,this.chartYAxisMax=3e4,this.cdr.markForCheck();return}let t=this.getDaysInCurrentMonth(),o=600,s=300,d=50,m=o-d*2,C=s-d*2,v=Math.max(...e.map(g=>g.revenue||g.amount||0),1);this.chartYAxisMax=this.niceRoundMax(v);let E=this.chartYAxisMax,P=e.map(g=>{let R=g.day||g.dayNumber||1,O=t>1?(R-1)/(t-1):0,A=d+O*m,D=g.revenue||g.amount||0,F=s-d-D/E*C,L=g.transactionCount??g.transactions??0,N=g.bonusesGranted??g.bonusEarned??g.bonusesAccrued??0,Ie=g.bonusesUsed??g.bonusUsed??0;return{x:A,y:F,day:R,revenue:D,transactions:L,bonusEarned:N,bonusUsed:Ie}});console.log("Updated chart cache with",P.length,"points"),this._chartDataCache=P,this.cdr.markForCheck()}niceRoundMax(e){if(e<=0)return 1e4;let t=Math.pow(10,Math.floor(Math.log10(e))),o=e/t,s=o<=1?1:o<=2?2:o<=5?5:10;return Math.ceil(s*t/1e3)*1e3||1e4}formatYAxisValue(e){if(e>=1e6){let t=e/1e6;return`${(t%1===0?`${t}`:t.toFixed(1)).replace(".",",")} \u043C\u043B\u043D`}if(e>=1e3){let t=e/1e3;return`${(t%1===0?`${t}`:t.toFixed(1)).replace(".",",")} \u0442\u044B\u0441`}return e.toLocaleString("ru-RU")}getYAxisLabels(){let e=this.chartYAxisMax||3e4,t=6,o=[];for(let s=t;s>=0;s--){let d=Math.round(e*s/t);o.push(this.formatYAxisValue(d)+" \u0442\u0433")}return o}formatCurrency(e,t=!0){if(e==null||isNaN(e))return t?"0 \u20B8":"0";let o=e.toLocaleString("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0});return t?`${o} \u20B8`:o}getInitials(e){if(!e||e.trim()==="")return"\u2014";let t=e.trim().split(" ").filter(o=>o.length>0);return t.length===0?"\u2014":t.map(o=>o[0]).join("").toUpperCase().slice(0,2)}formatAmount(e){return e.toLocaleString("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0})}formatPaymentId(e){if(!e)return"\u2014";if(e.includes("-"))return e;let t=parseInt(e,10);return isNaN(t)?e:`PAY-${String(t).padStart(3,"0")}`}getPaymentMethodForBadge(e){if(!e)return null;let t=e.toUpperCase();return t==="CASH"||t==="CARD"||t==="TRANSFER"?t:null}getPaymentMethodLabel(e){return{cash:"\u041D\u0430\u043B\u0438\u0447\u043D\u044B\u0435",card:"\u041A\u0430\u0440\u0442\u0430",transfer:"\u041F\u0435\u0440\u0435\u0432\u043E\u0434"}[e]||e}openTransactionModal(){this.transactionModalService.open()}openRefundModal(e){if(e.isRefund)return;this.isProcessingRefund=!1;let t={id:e.id,clientId:e.clientId,clientName:e.clientName,clientPhone:e.clientPhone,amount:e.amount,bonusEarned:e.bonusEarned,bonusUsed:e.bonusUsed,bonusRevoked:e.bonusRevoked,paymentMethod:e.paymentMethod,isRefund:e.isRefund,date:e.date,time:e.time};this.selectedPaymentForRefund=t,this.showRefundModal=!0}closeRefundModal(){this.isProcessingRefund||(this.showRefundModal=!1,this.selectedPaymentForRefund=null,this.isProcessingRefund=!1)}onRefundModalVisibleChange(e){!e&&!this.isProcessingRefund&&this.closeRefundModal()}confirmRefund(e){!e||this.isProcessingRefund||(this.isProcessingRefund=!0,this.paymentsService.refundPayment(e.id,{notes:e.refundReason||""}).subscribe({next:()=>{this.toastService.success("\u0412\u043E\u0437\u0432\u0440\u0430\u0442 \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0432\u044B\u043F\u043E\u043B\u043D\u0435\u043D"),this.loadRecentPayments(),this.isProcessingRefund=!1,this.showRefundModal=!1,this.selectedPaymentForRefund=null},error:t=>{console.error("Error processing refund:",t);let o=t?.error?.message||"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0432\u044B\u043F\u043E\u043B\u043D\u0435\u043D\u0438\u0438 \u0432\u043E\u0437\u0432\u0440\u0430\u0442\u0430";this.toastService.error(o)}}))}toggleRowExpansion(e){this.expandedRows.has(e)?this.expandedRows.delete(e):this.expandedRows.add(e)}isRowExpanded(e){return this.expandedRows.has(e)}getDaysInCurrentMonth(){let e=new Date;return new Date(e.getFullYear(),e.getMonth()+1,0).getDate()}getChartDataPoints(){if(this._chartDataCache&&this._chartDataCache.length>0)return this._chartDataCache;let e=this.getDaysInCurrentMonth(),t=600,o=300,s=50,d=t-s*2,m=o-s*2,C=[];if(e===0)return C;for(let v=1;v<=e;v++){let E=e>1?(v-1)/(e-1):0,P=s+E*d,g=5e3+v/e*2e4,R=Math.sin(v*.2)*2e3,O=Math.round(g+R),A=Math.floor(5+Math.random()*20+v/e*10),D=Math.round(O*.01*(.8+Math.random()*.4)),F=Math.round(O*.005*Math.random()),L=o-s-O/3e4*m;C.push({x:P,y:L,day:v,revenue:O,transactions:A,bonusEarned:D,bonusUsed:F})}return C}_chartDataCache=null;getChartData(){return this._chartDataCache&&this._chartDataCache.length>0?this._chartDataCache:this.isChartLoading?[]:this.getChartDataPoints()}getMonthName(){return["\u044F\u043D\u0432\u0430\u0440\u044F","\u0444\u0435\u0432\u0440\u0430\u043B\u044F","\u043C\u0430\u0440\u0442\u0430","\u0430\u043F\u0440\u0435\u043B\u044F","\u043C\u0430\u044F","\u0438\u044E\u043D\u044F","\u0438\u044E\u043B\u044F","\u0430\u0432\u0433\u0443\u0441\u0442\u0430","\u0441\u0435\u043D\u0442\u044F\u0431\u0440\u044F","\u043E\u043A\u0442\u044F\u0431\u0440\u044F","\u043D\u043E\u044F\u0431\u0440\u044F","\u0434\u0435\u043A\u0430\u0431\u0440\u044F"][new Date().getMonth()]}getTransactionsText(e){let t=e%10,o=e%100;return o>=11&&o<=19?"\u0442\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u0439":t===1?"\u0442\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u044F":t>=2&&t<=4?"\u0442\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u0438":"\u0442\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u0439"}getChartPath(){let e=this.getChartData();if(e.length===0)return"";let t=`M${e[0].x},${e[0].y}`;for(let o=1;o<e.length;o++)t+=` L${e[o].x},${e[o].y}`;return t}getAreaPath(){let e=this.getChartData();if(e.length===0)return"";let t=300,o=50,s=`M${e[0].x},${t-o}`;s+=` L${e[0].x},${e[0].y}`;for(let d=1;d<e.length;d++)s+=` L${e[d].x},${e[d].y}`;return s+=` L${e[e.length-1].x},${t-o} Z`,s}getXAxisLabels(){let e=this.getDaysInCurrentMonth(),t=[],o=[1,Math.ceil(e*.25),Math.ceil(e*.5),Math.ceil(e*.75),e];return[...new Set(o)].sort((d,m)=>d-m).map(d=>d.toString())}getDonutCircumference(){return 2*Math.PI*40}getDonutLoyaltyDash(){if(!this.salesByLoyalty)return"0 251";let e=this.getDonutCircumference();return`${this.salesByLoyalty.loyaltyPercent/100*e} ${e}`}getDonutNonLoyaltyDash(){if(!this.salesByLoyalty)return"0 251";let e=this.getDonutCircumference();return`${this.salesByLoyalty.nonLoyaltyPercent/100*e} ${e}`}getDonutNonLoyaltyOffset(){if(!this.salesByLoyalty)return 0;let e=this.getDonutCircumference();return-(this.salesByLoyalty.loyaltyPercent/100*e)}getKpiPeriodRange(){let e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate(),23,59,59),o;switch(this.kpiPeriod){case"3m":o=new Date(e.getFullYear(),e.getMonth()-3,e.getDate(),0,0,0);break;case"6m":o=new Date(e.getFullYear(),e.getMonth()-6,e.getDate(),0,0,0);break;case"1y":o=new Date(e.getFullYear()-1,e.getMonth(),e.getDate(),0,0,0);break;case"all":o=new Date(2e3,0,1,0,0,0);break;default:o=new Date(e.getFullYear(),e.getMonth(),1,0,0,0)}let s=o.toISOString().slice(0,19).replace("T","T"),d=t.toISOString().slice(0,19).replace("T","T");return{from:s,to:d}}onKpiPeriodChange(e){this.kpiPeriod=e;let{from:t,to:o}=this.getKpiPeriodRange();this.analyticsService.getKpiDashboard(t,o).pipe(b(()=>_(null))).subscribe(s=>{this.buildKpiMetricCardsOnly(s),this.cdr.detectChanges()})}buildKpiMetricCardsOnly(e){let t=e?.retention?.retentionRate!=null?Number(e.retention.retentionRate).toFixed(1):"\u2014",o=e?.efficiency?.redemptionRate!=null?Number(e.efficiency.redemptionRate).toFixed(1)+"%":"\u2014",s=e?.efficiency?.effectiveDiscount!=null?Number(e.efficiency.effectiveDiscount).toFixed(1)+"%":"\u2014",d=e?.efficiency?.burnRate!=null?Number(e.efficiency.burnRate).toFixed(1)+"%":"\u2014",m=e?.uplift?.aovUplift!=null?Number(e.uplift.aovUplift).toFixed(1)+"%":"\u2014",C=e?.revenue?.incrementalRevenuePercentage!=null?Number(e.revenue.incrementalRevenuePercentage).toFixed(1)+"%":"\u2014";this.kpiMetricCards=[{iconId:"average",iconBg:"linear-gradient(135deg, #e0e7ff, #c7d2fe)",value:t+(t!=="\u2014"?"%":""),label:"Retention",tooltip:"\u0414\u043E\u043B\u044F \u043A\u043B\u0438\u0435\u043D\u0442\u043E\u0432, \u0441\u043E\u0432\u0435\u0440\u0448\u0438\u0432\u0448\u0438\u0445 2 \u0438 \u0431\u043E\u043B\u0435\u0435 \u043F\u043E\u043A\u0443\u043F\u043E\u043A \u0432 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u043C \u043F\u0435\u0440\u0438\u043E\u0434\u0435, \u043E\u0442 \u043E\u0431\u0449\u0435\u0433\u043E \u0447\u0438\u0441\u043B\u0430 \u0430\u043A\u0442\u0438\u0432\u043D\u044B\u0445 \u043A\u043B\u0438\u0435\u043D\u0442\u043E\u0432. \u041F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u0442 \u0443\u0434\u0435\u0440\u0436\u0430\u043D\u0438\u0435."},{iconId:"average",iconBg:"linear-gradient(135deg, #e0e7ff, #c7d2fe)",value:o,label:"Redemption rate",tooltip:"\u0414\u043E\u043B\u044F \u043D\u0430\u0447\u0438\u0441\u043B\u0435\u043D\u043D\u044B\u0445 \u0431\u043E\u043D\u0443\u0441\u043E\u0432, \u043A\u043E\u0442\u043E\u0440\u0443\u044E \u043A\u043B\u0438\u0435\u043D\u0442\u044B \u043F\u043E\u0442\u0440\u0430\u0442\u0438\u043B\u0438 \u0432 \u043F\u0435\u0440\u0438\u043E\u0434\u0435. \u041F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u0442, \u043D\u0430\u0441\u043A\u043E\u043B\u044C\u043A\u043E \u0430\u043A\u0442\u0438\u0432\u043D\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u044E\u0442 \u0431\u043E\u043D\u0443\u0441\u044B."},{iconId:"average",iconBg:"linear-gradient(135deg, #e0e7ff, #c7d2fe)",value:s,label:"Effective discount",tooltip:"\u0421\u0440\u0435\u0434\u043D\u0438\u0439 \u0444\u0430\u043A\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u0441\u043A\u0438\u0434\u043E\u0447\u043D\u044B\u0439 \u043F\u0440\u043E\u0446\u0435\u043D\u0442 \u043F\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u043D\u044B\u043C \u0431\u043E\u043D\u0443\u0441\u0430\u043C \u043E\u0442\u043D\u043E\u0441\u0438\u0442\u0435\u043B\u044C\u043D\u043E \u0432\u044B\u0440\u0443\u0447\u043A\u0438 \u0432 \u043F\u0435\u0440\u0438\u043E\u0434\u0435."},{iconId:"average",iconBg:"linear-gradient(135deg, #e0e7ff, #c7d2fe)",value:d,label:"Burn rate",tooltip:"\u0414\u043E\u043B\u044F \u043D\u0430\u0447\u0438\u0441\u043B\u0435\u043D\u043D\u044B\u0445 \u0437\u0430 \u043F\u043E\u0441\u043B\u0435\u0434\u043D\u0438\u0435 12 \u043C\u0435\u0441\u044F\u0446\u0435\u0432 \u0431\u043E\u043D\u0443\u0441\u043E\u0432, \u043A\u043E\u0442\u043E\u0440\u0430\u044F \u0441\u0433\u043E\u0440\u0435\u043B\u0430 (\u0438\u0441\u0442\u0435\u043A \u0441\u0440\u043E\u043A). \u041F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u0442 \u043F\u043E\u0442\u0435\u0440\u0438 \u043E\u0442 \u043D\u0435\u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0438\u044F."},{iconId:"average",iconBg:"linear-gradient(135deg, #e0e7ff, #c7d2fe)",value:m,label:"AOV uplift",tooltip:"\u0420\u0430\u0437\u043D\u0438\u0446\u0430 \u0441\u0440\u0435\u0434\u043D\u0435\u0433\u043E \u0447\u0435\u043A\u0430 \u043C\u0435\u0436\u0434\u0443 \u043F\u043B\u0430\u0442\u0435\u0436\u0430\u043C\u0438 \u0441 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0438\u0435\u043C \u0431\u043E\u043D\u0443\u0441\u043E\u0432 \u0438 \u0431\u0435\u0437. \u041F\u043E\u043B\u043E\u0436\u0438\u0442\u0435\u043B\u044C\u043D\u044B\u0439 uplift \u2014 \u043A\u043B\u0438\u0435\u043D\u0442\u044B \u0441 \u0431\u043E\u043D\u0443\u0441\u0430\u043C\u0438 \u0442\u0440\u0430\u0442\u044F\u0442 \u0431\u043E\u043B\u044C\u0448\u0435."},{iconId:"average",iconBg:"linear-gradient(135deg, #e0e7ff, #c7d2fe)",value:C,label:"Incremental revenue %",tooltip:"\u0414\u043E\u043B\u044F \u0434\u043E\u043F\u043E\u043B\u043D\u0438\u0442\u0435\u043B\u044C\u043D\u043E\u0439 \u0432\u044B\u0440\u0443\u0447\u043A\u0438 \u043E\u0442 \u043F\u043B\u0430\u0442\u0435\u0436\u0435\u0439 \u0441 \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u0438\u0435\u043C \u0431\u043E\u043D\u0443\u0441\u043E\u0432 \u0432 \u043E\u0431\u0449\u0435\u0439 \u0432\u044B\u0440\u0443\u0447\u043A\u0435 \u043F\u0435\u0440\u0438\u043E\u0434\u0430."}]}getXAxisLabelPositions(){let e=this.getDaysInCurrentMonth(),t=600,o=50,s=t-o*2;return this.getXAxisLabels().map(m=>{let C=parseInt(m,10),v=e>1?(C-1)/(e-1):0;return o+v*s})}openPaymentView(e){let t=this.recentPayments.find(o=>o.id===e);t&&(this.selectedPaymentSearchResult={txId:t.id,clientId:t.clientId,clientName:t.clientName,clientPhone:t.clientPhone,clientEmail:null,amount:t.amount,status:t.isRefund?"REFUNDED":"COMPLETED",paymentMethod:t.paymentMethod?.toUpperCase(),initiatedBy:t.initiatedBy||null,createdAt:t.date+"T"+t.time,refundedPaymentTxId:null,bonusGranted:t.bonusEarned,bonusUsed:t.bonusUsed,bonusRevoked:t.bonusRevoked,refundReason:t.refundReason||null}),this.selectedPaymentTxId=e,this.showPaymentViewModal=!0}closePaymentView(){this.showPaymentViewModal=!1,this.selectedPaymentTxId=null,this.selectedPaymentSearchResult=null}onPaymentUpdated(){this.loadRecentPayments()}static \u0275fac=function(t){return new(t||a)(J(ue))};static \u0275cmp=Z({type:a,selectors:[["app-home-page"]],decls:6,vars:8,consts:[[1,"page-wrapper"],[1,"dashboard"],["class","page-loading-container",4,"ngIf"],[4,"ngIf"],[3,"visibleChange","confirm","visible","payment","isProcessing"],[3,"visibleChange","paymentUpdated","refundedPaymentClick","visible","paymentTxId","paymentSearchResult"],[1,"page-loading-container"],["type","logo","size","large",3,"visible","overlay"],[1,"dashboard-header"],["buttonType","primary","size","medium",3,"onClick"],["viewBox","0 0 24 24","fill","none",1,"create-icon"],["d","M6 12H18M12 6V18","stroke","currentColor","stroke-width","2.5","stroke-linecap","round","stroke-linejoin","round"],[1,"create-label"],["class","expiring-bonuses-card",4,"ngIf"],[1,"card-groups"],[1,"card-group"],[1,"card-group-header"],[1,"card-group-icon","card-group-icon-payments"],["viewBox","0 0 24 24","fill","none","stroke","currentColor","stroke-width","1.5","stroke-linecap","round","stroke-linejoin","round"],["d","M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"],[1,"card-group-title"],[1,"metric-list"],["class","metric-row",4,"ngFor","ngForOf"],[1,"card-group-icon","card-group-icon-bonus"],["viewBox","0 0 24 24","fill","none","stroke","currentColor","stroke-width","1.5"],["d","M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"],[1,"card-group-header","card-group-header-kpi"],[1,"card-group-icon","card-group-icon-kpi"],["d","M3 3v18h18"],["d","M18 17V9"],["d","M13 17V5"],["d","M8 17v-3"],[1,"kpi-period-select-wrapper"],[1,"kpi-period-select",3,"ngModelChange","ngModel"],["value","1m"],["value","3m"],["value","6m"],["value","1y"],["value","all"],["class","metric-row kpi-metric-row",3,"title",4,"ngFor","ngForOf"],[1,"card-group-icon","card-group-icon-users"],["d","M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"],["cx","9","cy","7","r","4"],["d","M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"],["class","top-customers-list",4,"ngIf"],[1,"charts-section"],[1,"chart-card","line-chart-card"],[1,"chart-title"],[1,"chart-container"],[1,"chart-y-axis"],[1,"chart-y-axis-inner"],[4,"ngFor","ngForOf"],[1,"chart-area"],[1,"chart-svg-wrapper"],["viewBox","0 0 600 300","preserveAspectRatio","none",1,"line-chart"],["id","chartGradient","x1","0%","y1","0%","x2","0%","y2","100%"],["offset","0%",2,"stop-color","#22c55e","stop-opacity","0.3"],["offset","100%",2,"stop-color","#22c55e","stop-opacity","0.02"],["stroke","#e2e8f0","stroke-width","1","opacity","0.5"],["x1","50","y1","50","x2","550","y2","50","vector-effect","non-scaling-stroke"],["x1","50","y1","100","x2","550","y2","100","vector-effect","non-scaling-stroke"],["x1","50","y1","150","x2","550","y2","150","vector-effect","non-scaling-stroke"],["x1","50","y1","200","x2","550","y2","200","vector-effect","non-scaling-stroke"],["x1","50","y1","250","x2","550","y2","250","vector-effect","non-scaling-stroke"],["fill","url(#chartGradient)"],["fill","none","stroke","#22c55e","stroke-width","2.5","stroke-linecap","round","stroke-linejoin","round","vector-effect","non-scaling-stroke"],[1,"chart-points"],["class","chart-point-wrapper",3,"left","top",4,"ngFor","ngForOf"],[1,"chart-x-axis"],[1,"chart-x-axis-caption"],[1,"chart-x-axis-labels"],[3,"left",4,"ngFor","ngForOf"],["class","chart-card donut-chart-card",4,"ngIf"],[1,"table-section"],[1,"table-header"],[1,"table-title"],["routerLink","/payments",1,"view-all-link"],[1,"table-container"],[1,"payments-table"],[1,"th-id"],[1,"th-client"],[1,"th-amount"],[1,"th-bonuses"],[1,"th-method"],[1,"th-status"],[1,"th-date"],[1,"th-actions"],[1,"expiring-bonuses-card"],[1,"expiring-bonuses-content"],[1,"expiring-bonuses-icon"],["viewBox","0 0 24 24","fill","none"],["d","M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z","stroke","currentColor","stroke-width","1.5"],[1,"expiring-bonuses-stats"],[1,"expiring-bonuses-label"],[1,"expiring-bonuses-value"],["routerLink","/bonus-expiring","title","\u041F\u0435\u0440\u0435\u0439\u0442\u0438 \u043A \u0441\u043F\u0438\u0441\u043A\u0443",1,"expiring-bonuses-link"],["d","M9 18l6-6-6-6","stroke","currentColor","stroke-width","2","stroke-linecap","round","stroke-linejoin","round"],[1,"metric-row"],[1,"metric-label"],[1,"metric-right"],[1,"metric-value"],["class","metric-change",3,"positive","negative",4,"ngIf"],[1,"metric-change"],[1,"metric-row","kpi-metric-row",3,"title"],["class","metric-tooltip-icon","tabindex","0",3,"title",4,"ngIf"],["tabindex","0",1,"metric-tooltip-icon",3,"title"],["viewBox","0 0 24 24","fill","none","stroke","currentColor","stroke-width","2","stroke-linecap","round","stroke-linejoin","round"],["cx","12","cy","12","r","10"],["d","M12 16v-4M12 8h.01"],[1,"top-customers-list"],[1,"top-customers-header"],[1,"top-customers-title"],["title","\u0421\u043C\u043E\u0442\u0440\u0435\u0442\u044C \u0432\u0441\u0435\u0445 \u043A\u043B\u0438\u0435\u043D\u0442\u043E\u0432 \u043F\u043E \u0441\u0443\u043C\u043C\u0435 \u0442\u0440\u0430\u0442",1,"top-customers-link",3,"routerLink","queryParams"],["viewBox","0 0 24 24","fill","none",1,"top-customers-arrow"],[1,"top-customers-ul"],["class","top-customer-item",4,"ngFor","ngForOf"],[1,"top-customer-item"],[1,"top-customer-link",3,"routerLink"],[1,"top-customer-name"],[1,"top-customer-spent"],[1,"chart-point-wrapper"],[1,"chart-point"],[1,"chart-tooltip"],[1,"tooltip-day"],[1,"tooltip-stats"],[1,"tooltip-row"],[1,"tooltip-label"],[1,"tooltip-revenue"],[1,"tooltip-value"],[1,"tooltip-bonus-earned"],["class","tooltip-row",4,"ngIf"],[1,"tooltip-bonus-used"],[1,"chart-card","donut-chart-card"],[1,"donut-container"],["viewBox","0 0 100 100","preserveAspectRatio","xMidYMid meet",1,"donut-chart"],["cx","50","cy","50","r","40","fill","none","stroke","#e2e8f0","stroke-width","16"],["cx","50","cy","50","r","40","fill","none","stroke","#22c55e","stroke-width","16","stroke-dashoffset","0","transform","rotate(-90 50 50)"],["cx","50","cy","50","r","40","fill","none","stroke","#e2e8f0","stroke-width","16","transform","rotate(-90 50 50)"],[1,"donut-legend"],[1,"legend-item"],[1,"legend-color","loyalty"],[1,"legend-label"],[1,"legend-value"],[1,"legend-count"],[1,"legend-color","non-loyalty"],[1,"payment-row"],[1,"td-id"],[1,"payment-id","clickable",3,"click"],[1,"td-client"],[1,"client-cell"],[1,"client-avatar"],[1,"client-info"],[1,"client-name-link",3,"routerLink"],[1,"client-name"],[1,"client-phone"],[1,"td-amount"],[1,"amount-value"],[1,"td-bonuses"],[1,"bonus-info"],["badgeType","bonusGranted","size","medium","icon","star","class","bonus-badge",4,"ngIf"],["badgeType","bonusUsed","size","medium","icon","check","class","bonus-badge",4,"ngIf"],["badgeType","refund","size","medium","icon","refund","class","bonus-badge",4,"ngIf"],["class","bonus-none",4,"ngIf"],[1,"td-method"],["badgeType","paymentMethod","size","medium",3,"paymentMethod"],[1,"td-status"],["size","medium",3,"badgeType","icon"],[1,"td-date"],[1,"date-info"],[1,"date-text"],[1,"time-text"],[1,"td-actions"],[1,"actions-cell"],[1,"action-link",3,"routerLink"],["iconButtonType","view","size","small","tooltip","\u041F\u0440\u043E\u0441\u043C\u043E\u0442\u0440 \u043A\u043B\u0438\u0435\u043D\u0442\u0430"],["xmlns","http://www.w3.org/2000/svg","viewBox","0 0 24 24","fill","none"],["d","M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z","stroke","currentColor","stroke-width","1.5"],["cx","12","cy","12","r","3","stroke","currentColor","stroke-width","1.5"],["iconButtonType","refund","size","small","tooltip","\u0412\u043E\u0437\u0432\u0440\u0430\u0442",3,"onClick","disabled"],["d","M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6","stroke","currentColor","stroke-width","1.5","stroke-linecap","round","stroke-linejoin","round"],["iconButtonType","ghost","size","small",3,"onClick","tooltip"],["d","M6 9l6 6 6-6","stroke","currentColor","stroke-width","1.5","stroke-linecap","round","stroke-linejoin","round"],["class","payment-details-row",4,"ngIf"],["badgeType","bonusGranted","size","medium","icon","star",1,"bonus-badge"],["badgeType","bonusUsed","size","medium","icon","check",1,"bonus-badge"],["badgeType","refund","size","medium","icon","refund",1,"bonus-badge"],[1,"bonus-none"],[1,"payment-details-row"],["colspan","9",1,"payment-details-cell"],[1,"payment-details-content"],[1,"refund-details-grid"],[1,"refund-reason-section"],[1,"refund-label"],["class","refund-reason-text",4,"ngIf"],["class","refund-reason-empty",4,"ngIf"],[1,"refund-by-section"],["class","refund-by-text",4,"ngIf"],["class","refund-by-empty",4,"ngIf"],[1,"refund-reason-text"],[1,"refund-reason-empty"],[1,"refund-by-text"],[1,"refund-by-empty"]],template:function(t,o){t&1&&(n(0,"div",0)(1,"div",1),f(2,Be,2,2,"div",2)(3,lt,122,14,"div",3),i(),n(4,"app-refund-confirmation-modal",4),S("visibleChange",function(d){return o.onRefundModalVisibleChange(d)})("confirm",function(d){return o.confirmRefund(d)}),i(),n(5,"app-payment-view-modal",5),S("visibleChange",function(){return o.closePaymentView()})("paymentUpdated",function(){return o.onPaymentUpdated()})("refundedPaymentClick",function(d){return o.openPaymentView(d)}),i()()),t&2&&(r(2),c("ngIf",o.isLoading),r(),c("ngIf",!o.isLoading),r(),c("visible",o.showRefundModal)("payment",o.selectedPaymentForRefund)("isProcessing",o.isProcessingRefund),r(),c("visible",o.showPaymentViewModal)("paymentTxId",o.selectedPaymentTxId)("paymentSearchResult",o.selectedPaymentSearchResult))},dependencies:[le,oe,ae,re,_e,ve,be,xe,fe,he,de,ce,Oe,ye,Se,ge,Ee,Re],styles:['[_nghost-%COMP%]{display:block;height:100%}.page-wrapper[_ngcontent-%COMP%]{min-height:100%;margin:-2rem;padding:2rem;background:linear-gradient(180deg,#f0fdf4,#f8fafc 50% 100%)}.dashboard[_ngcontent-%COMP%]{max-width:1400px;margin:0 auto;position:relative;min-height:400px}.page-loading-container[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;min-height:60vh;width:100%}.dashboard-header[_ngcontent-%COMP%]{display:flex;justify-content:flex-start;align-items:flex-start;margin-bottom:2rem}.dashboard-title[_ngcontent-%COMP%]{font-size:1.75rem;font-weight:700;color:#0f172a;margin:0 0 .25rem}.refunds-icon[_ngcontent-%COMP%]{color:#dc2626}.dashboard-subtitle[_ngcontent-%COMP%]{font-size:.9375rem;color:#64748b;margin:0}.new-transaction-btn[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;padding:.75rem 1.5rem;background:#16a34a;color:#fff;border:none;border-radius:12px;font-size:.9375rem;font-weight:600;cursor:pointer;transition:all .2s ease}.new-transaction-btn[_ngcontent-%COMP%]:hover{background:#15803d}.new-transaction-btn[_ngcontent-%COMP%]   .btn-icon[_ngcontent-%COMP%]{width:18px;height:18px}.expiring-bonuses-card[_ngcontent-%COMP%]{background:linear-gradient(135deg,#fef3c7,#fde68a);border:1px solid #fcd34d;border-radius:16px;padding:1rem 1.25rem;margin-bottom:1.5rem}.expiring-bonuses-content[_ngcontent-%COMP%]{display:flex;align-items:center;gap:1rem}.expiring-bonuses-icon[_ngcontent-%COMP%]{width:44px;height:44px;border-radius:12px;background:#d9770626;display:flex;align-items:center;justify-content:center;flex-shrink:0}.expiring-bonuses-icon[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:24px;height:24px;color:#d97706}.expiring-bonuses-stats[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;gap:.25rem}.expiring-bonuses-label[_ngcontent-%COMP%]{font-size:.8125rem;font-weight:600;color:#92400e}.expiring-bonuses-value[_ngcontent-%COMP%]{font-size:1rem;font-weight:600;color:#78350f}.expiring-bonuses-link[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:10px;background:#d9770633;color:#b45309;transition:background .2s,color .2s}.expiring-bonuses-link[_ngcontent-%COMP%]:hover{background:#d977064d;color:#92400e}.expiring-bonuses-link[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:20px;height:20px}.card-groups[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:1.25rem;margin-bottom:1.5rem}.card-group[_ngcontent-%COMP%]{flex:1;min-width:0;background:#fff;border-radius:14px;padding:1rem 1.25rem;border:1px solid #e5e7eb;box-shadow:0 1px 3px #0000000d;transition:box-shadow .2s ease}.card-group[_ngcontent-%COMP%]:hover{box-shadow:0 4px 12px #0000000f}.card-group-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.625rem;margin-bottom:.75rem;padding-bottom:.625rem;border-bottom:1px solid #f1f5f9}.card-group-icon[_ngcontent-%COMP%]{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}.card-group-icon[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:20px;height:20px}.card-group-icon-payments[_ngcontent-%COMP%]{background:linear-gradient(135deg,#dcfce7,#bbf7d0);color:#15803d}.card-group-icon-bonus[_ngcontent-%COMP%]{background:linear-gradient(135deg,#fef3c7,#fde68a);color:#b45309}.card-group-icon-kpi[_ngcontent-%COMP%]{background:linear-gradient(135deg,#e0e7ff,#c7d2fe);color:#4338ca}.card-group-icon-users[_ngcontent-%COMP%]{background:linear-gradient(135deg,#fce7f3,#fbcfe8);color:#be185d}.card-group-header-kpi[_ngcontent-%COMP%]{flex-wrap:wrap;gap:.5rem}.card-group-header-kpi[_ngcontent-%COMP%]   .card-group-title[_ngcontent-%COMP%]{flex:1;min-width:0}.kpi-period-select-wrapper[_ngcontent-%COMP%]{flex-shrink:0}.kpi-period-select[_ngcontent-%COMP%]{font-size:.75rem;padding:.25rem .5rem;border:1px solid #e2e8f0;border-radius:6px;background:#fff;color:#0f172a;cursor:pointer}.kpi-period-select[_ngcontent-%COMP%]:focus{outline:none;border-color:#22c55e}.metric-tooltip-icon[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;margin-left:.25rem;cursor:help;vertical-align:middle;color:#64748b}.metric-tooltip-icon[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:14px;height:14px;display:block}.metric-tooltip-icon[_ngcontent-%COMP%]:hover{color:#22c55e}.card-group-title[_ngcontent-%COMP%]{font-size:.875rem;font-weight:700;color:#0f172a;margin:0;letter-spacing:.01em}.metric-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.375rem}.metric-row[_ngcontent-%COMP%]{display:flex;align-items:baseline;justify-content:space-between;gap:.5rem;font-size:.8125rem;line-height:1.45;padding:.25rem 0}.metric-label[_ngcontent-%COMP%]{color:#64748b;flex-shrink:0}.metric-right[_ngcontent-%COMP%]{display:inline-flex;align-items:baseline;gap:.35rem}.metric-value[_ngcontent-%COMP%]{font-weight:600;color:#0f172a}.metric-change[_ngcontent-%COMP%]{font-size:.75rem;font-weight:600}.metric-change.positive[_ngcontent-%COMP%]{color:#16a34a}.metric-change.negative[_ngcontent-%COMP%]{color:#dc2626}.top-customers-list[_ngcontent-%COMP%]{margin-top:.625rem;padding-top:.625rem;border-top:1px solid #f1f5f9}.top-customers-header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:.5rem;margin-bottom:.35rem}.top-customers-title[_ngcontent-%COMP%]{font-size:.75rem;font-weight:600;color:#64748b}.top-customers-link[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;color:#64748b;text-decoration:none;padding:.2rem;border-radius:6px;transition:color .15s,background .15s}.top-customers-link[_ngcontent-%COMP%]:hover{color:#16a34a;background:#16a34a14}.top-customers-arrow[_ngcontent-%COMP%]{width:16px;height:16px}.top-customers-ul[_ngcontent-%COMP%]{list-style:none;padding:0;margin:0}.top-customer-item[_ngcontent-%COMP%]{margin-bottom:.125rem}.top-customer-link[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:.25rem 0;text-decoration:none;color:#0f172a;font-size:.8125rem;transition:color .15s}.top-customer-link[_ngcontent-%COMP%]:hover{color:#16a34a}.top-customer-name[_ngcontent-%COMP%]{font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70%}.top-customer-spent[_ngcontent-%COMP%]{font-weight:600;color:#16a34a;flex-shrink:0}@media (max-width: 900px){.card-groups[_ngcontent-%COMP%]{flex-wrap:wrap}.card-group[_ngcontent-%COMP%]{min-width:calc(50% - .5rem)}}@media (max-width: 500px){.card-group[_ngcontent-%COMP%]{min-width:100%}}.kpi-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem}.kpi-icon[_ngcontent-%COMP%]{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.25rem}.kpi-icon[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:24px;height:24px;color:#16a34a;display:block}.kpi-change[_ngcontent-%COMP%]{font-size:.8125rem;font-weight:600;padding:.25rem .625rem;border-radius:20px;background:#f0fdf4;color:#16a34a}.kpi-change.positive[_ngcontent-%COMP%]{background:#f0fdf4;color:#16a34a}.kpi-change.negative[_ngcontent-%COMP%]{background:#fef2f2;color:#dc2626}.kpi-value[_ngcontent-%COMP%]{font-size:2rem;font-weight:700;color:#0f172a;margin-bottom:.25rem}.kpi-label[_ngcontent-%COMP%]{font-size:.875rem;color:#64748b}.charts-section[_ngcontent-%COMP%]{display:flex;flex-direction:row;gap:1.5rem;margin-bottom:2rem}@media (max-width: 1024px){.charts-section[_ngcontent-%COMP%]{flex-direction:column}}.chart-card[_ngcontent-%COMP%]{background:#fff;border-radius:16px;padding:1.5rem;box-shadow:0 1px 3px #0000000d}.chart-title[_ngcontent-%COMP%]{font-size:1.125rem;font-weight:600;color:#0f172a;margin:0 0 1.5rem}.line-chart-card[_ngcontent-%COMP%]{flex:1;min-width:0;min-height:350px;overflow:visible}.chart-container[_ngcontent-%COMP%]{display:flex;height:320px;overflow:visible}.chart-y-axis[_ngcontent-%COMP%]{height:300px;flex-shrink:0;padding-right:1rem;font-size:.75rem;color:#94a3b8}.chart-y-axis-inner[_ngcontent-%COMP%]{display:flex;flex-direction:column;justify-content:space-between;height:250px}.chart-area[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;min-height:0;overflow:visible}.chart-svg-wrapper[_ngcontent-%COMP%]{height:300px;flex-shrink:0;position:relative;overflow:visible}.line-chart[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;display:block}.chart-points[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;overflow:visible}.chart-point-wrapper[_ngcontent-%COMP%]{position:absolute;transform:translate(-50%,-50%);cursor:pointer;z-index:1;pointer-events:auto;padding:8px}.chart-point-wrapper[_ngcontent-%COMP%]:hover{z-index:10}.chart-point[_ngcontent-%COMP%]{width:10px;height:10px;background:#22c55e;border-radius:50%;transition:transform .15s ease,box-shadow .15s ease}.chart-point-wrapper[_ngcontent-%COMP%]:hover   .chart-point[_ngcontent-%COMP%]{transform:scale(1.3);box-shadow:0 0 0 4px #22c55e33}.chart-point.last-point[_ngcontent-%COMP%]{width:12px;height:12px;background:#fff;border:2.5px solid #22c55e;box-sizing:border-box}.chart-tooltip[_ngcontent-%COMP%]{position:absolute;bottom:calc(100% + 10px);left:50%;transform:translate(-50%) translateY(6px) scale(.97);background:#1f2937;color:#fff;padding:.625rem .875rem;border-radius:8px;font-size:.8125rem;white-space:nowrap;opacity:0;visibility:hidden;transition:all .3s cubic-bezier(.4,0,.2,1);box-shadow:0 4px 12px #00000026;pointer-events:none}.chart-tooltip[_ngcontent-%COMP%]:after{content:"";position:absolute;top:100%;left:50%;transform:translate(-50%);border:6px solid transparent;border-top-color:#1f2937;transition:opacity .3s ease}.chart-point-wrapper[_ngcontent-%COMP%]:hover   .chart-tooltip[_ngcontent-%COMP%]{opacity:1;visibility:visible;transform:translate(-50%) translateY(0) scale(1)}.tooltip-day[_ngcontent-%COMP%]{font-weight:600;margin-bottom:.5rem;padding-bottom:.375rem;border-bottom:1px solid #374151;color:#f3f4f6}.tooltip-stats[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.tooltip-row[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;gap:1rem}.tooltip-label[_ngcontent-%COMP%]{color:#9ca3af;font-size:.75rem}.tooltip-value[_ngcontent-%COMP%]{color:#f3f4f6;font-weight:500}.tooltip-revenue[_ngcontent-%COMP%]{color:#22c55e;font-weight:600}.tooltip-bonus-earned[_ngcontent-%COMP%]{color:#fbbf24;font-weight:600}.tooltip-bonus-used[_ngcontent-%COMP%]{color:#f472b6;font-weight:600}.chart-x-axis[_ngcontent-%COMP%]{display:flex;align-items:baseline;gap:.5rem;height:20px;padding-top:.5rem;font-size:.75rem;color:#94a3b8}.chart-x-axis-caption[_ngcontent-%COMP%]{flex-shrink:0;font-size:.75rem;color:#94a3b8}.chart-x-axis-labels[_ngcontent-%COMP%]{position:relative;flex:1;height:100%}.chart-x-axis-labels[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{position:absolute;transform:translate(-50%)}.donut-chart-card[_ngcontent-%COMP%]{display:flex;flex-direction:column;min-width:280px;width:320px;flex-shrink:0}.donut-container[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;justify-content:center;padding:1.5rem;overflow:visible;min-height:220px}.donut-chart[_ngcontent-%COMP%]{width:200px;height:200px;display:block;overflow:visible}.donut-legend[_ngcontent-%COMP%]{display:flex;justify-content:center;gap:2rem;padding-top:.5rem}.legend-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;font-size:.8125rem;color:#64748b}.legend-color[_ngcontent-%COMP%]{width:12px;height:12px;border-radius:3px;flex-shrink:0}.legend-color.loyalty[_ngcontent-%COMP%]{background:#22c55e}.legend-color.non-loyalty[_ngcontent-%COMP%]{background:#e2e8f0}.legend-label[_ngcontent-%COMP%]{font-size:.75rem;color:#64748b}.legend-value[_ngcontent-%COMP%]{font-weight:700;font-size:1rem;color:#0f172a}.legend-count[_ngcontent-%COMP%]{font-size:.8125rem;color:#64748b;margin-top:.15rem}.table-section[_ngcontent-%COMP%]{margin-bottom:2rem}.table-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}.table-title[_ngcontent-%COMP%]{font-size:1.125rem;font-weight:600;color:#0f172a;margin:0}.view-all-link[_ngcontent-%COMP%]{font-size:.875rem;color:#16a34a;text-decoration:none;font-weight:500;transition:color .2s ease}.view-all-link[_ngcontent-%COMP%]:hover{color:#15803d}.table-container[_ngcontent-%COMP%]{background:#fff;border-radius:16px;box-shadow:0 1px 3px #00000014;border:1px solid #e5e7eb;overflow:hidden}.payments-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}.payments-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{padding:1rem;text-align:left;font-size:.75rem;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:.5px;background:#f8fafc;border-bottom:1px solid #e5e7eb}.payments-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:1rem;border-bottom:1px solid #f1f5f9}.payment-row[_ngcontent-%COMP%]{transition:background .15s}.payment-row[_ngcontent-%COMP%]:hover{background:#f8fafc}.payment-row[_ngcontent-%COMP%]:last-child   td[_ngcontent-%COMP%]{border-bottom:none}.td-id[_ngcontent-%COMP%]{min-width:100px}.payment-id[_ngcontent-%COMP%]{font-family:monospace;font-weight:600;color:#64748b;font-size:.875rem}.payment-id.clickable[_ngcontent-%COMP%]{color:#64748b;cursor:pointer;text-decoration:underline;transition:color .2s}.payment-id.clickable[_ngcontent-%COMP%]:hover{color:#475569}.client-cell[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem}.client-avatar[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#f0fdf4,#dcfce7);color:#16a34a;display:flex;align-items:center;justify-content:center;font-size:.875rem;font-weight:600;flex-shrink:0}.client-info[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.15rem}.client-name-link[_ngcontent-%COMP%]{text-decoration:none;color:inherit;transition:color .15s}.client-name-link[_ngcontent-%COMP%]:hover{color:#16a34a}.client-name[_ngcontent-%COMP%]{font-size:.9rem;font-weight:600;color:#1f2937;cursor:pointer}.client-name-link[_ngcontent-%COMP%]:hover   .client-name[_ngcontent-%COMP%]{color:#16a34a}.client-phone[_ngcontent-%COMP%]{font-size:.8rem;color:#64748b}.amount-value[_ngcontent-%COMP%]{font-size:.95rem;font-weight:600;color:#16a34a}.bonus-info[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}.bonus-badge[_ngcontent-%COMP%]{display:inline-block}.bonus-none[_ngcontent-%COMP%]{font-size:.8rem;color:#94a3b8}.date-info[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.15rem}.date-text[_ngcontent-%COMP%]{font-size:.85rem;color:#1f2937;font-weight:500}.time-text[_ngcontent-%COMP%]{font-size:.75rem;color:#64748b}.actions-cell[_ngcontent-%COMP%]{display:flex;gap:.5rem;align-items:center}.action-link[_ngcontent-%COMP%]{display:inline-flex;text-decoration:none;color:inherit}.payments-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr.payment-details-row[_ngcontent-%COMP%]{background:transparent}.payments-table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr.payment-details-row[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{border-top:none;padding:0}.payment-details-cell[_ngcontent-%COMP%]{padding:0!important;background:transparent}.payment-details-content[_ngcontent-%COMP%]{padding:1rem 1.5rem;overflow:hidden;animation:_ngcontent-%COMP%_slideDown .3s ease-out}@keyframes _ngcontent-%COMP%_slideDown{0%{opacity:0;max-height:0}to{opacity:1;max-height:300px}}.refund-details-grid[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:flex-start;gap:2rem}.refund-reason-section[_ngcontent-%COMP%]{flex:1;text-align:left}.refund-by-section[_ngcontent-%COMP%]{flex:0 0 auto;text-align:right;min-width:200px}.refund-reason-section[_ngcontent-%COMP%], .refund-by-section[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.5rem}.refund-label[_ngcontent-%COMP%]{font-size:.875rem;font-weight:600;color:#475569}.refund-reason-text[_ngcontent-%COMP%]{padding:.75rem;background:transparent;border:none;border-radius:0;font-size:.875rem;color:#1f2937;line-height:1.6;white-space:pre-wrap;text-align:left}.refund-by-text[_ngcontent-%COMP%]{padding:.75rem 0;background:transparent;border:none;border-radius:0;font-size:.875rem;color:#1f2937;line-height:1.6;white-space:pre-wrap;text-align:right}.refund-reason-empty[_ngcontent-%COMP%]{padding:.75rem;background:transparent;border:none;border-radius:0;font-size:.875rem;color:#94a3b8;font-style:italic;text-align:left}.refund-by-empty[_ngcontent-%COMP%]{padding:.75rem 0;background:transparent;border:none;border-radius:0;font-size:.875rem;color:#94a3b8;font-style:italic;text-align:right}.actions-cell[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{transition:transform .3s ease}.actions-cell[_ngcontent-%COMP%]   svg.rotated[_ngcontent-%COMP%]{transform:rotate(180deg)}[_nghost-%COMP%]     app-button svg, app-button[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:18px;height:18px;flex-shrink:0;display:block}[_nghost-%COMP%]     app-button.size-small svg, app-button.size-small[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:16px;height:16px}.btn-icon[_ngcontent-%COMP%]{width:18px;height:18px;flex-shrink:0;display:block}[_nghost-%COMP%]     .dashboard-header app-button button{height:44px;padding:0 1rem}[_nghost-%COMP%]     .dashboard-header app-button button svg.create-icon{width:32px;height:32px;flex-shrink:0}[_nghost-%COMP%]     app-button button .create-label{display:inline-flex;align-items:center;line-height:1.5}@media (max-width: 768px){.page-wrapper[_ngcontent-%COMP%]{margin:-1rem;padding:1rem}.dashboard-header[_ngcontent-%COMP%]{flex-direction:column;gap:1rem}.new-transaction-btn[_ngcontent-%COMP%]{width:100%;justify-content:center}.clients-table[_ngcontent-%COMP%]{display:block;overflow-x:auto}}']})}return a})();export{Dt as HomePageComponent};
