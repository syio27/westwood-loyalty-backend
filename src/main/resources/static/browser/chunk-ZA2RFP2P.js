import{a as R,b as W}from"./chunk-FXUHRSHQ.js";import{a as G}from"./chunk-RYDIYJIA.js";import{a as V}from"./chunk-KB5JM5GV.js";import{a as H}from"./chunk-ALSAQHEB.js";import{a as N}from"./chunk-NNW3XHHL.js";import{a as z}from"./chunk-74SLES4X.js";import"./chunk-3B24VZJ2.js";import{a as F}from"./chunk-BQSGCHPY.js";import{a as L}from"./chunk-NWGGWLRD.js";import{$ as _,$a as P,Ba as n,Ca as i,Da as f,Db as k,Ha as y,Hb as A,Ia as v,Ja as p,Qa as a,Ra as m,Sa as w,T as g,Ta as h,Z as b,_ as E,_a as T,aa as M,ab as S,jb as I,kb as B,la as o,oa as O,qb as D,ta as c,xa as u,za as x}from"./chunk-SR6TZKDI.js";var U=t=>["/clients",t];function $(t,s){t&1&&(n(0,"div",6),f(1,"app-loader",7),i()),t&2&&(o(),u("visible",!0)("overlay",!1))}function j(t,s){t&1&&(n(0,"div",10),_(),n(1,"svg",11),f(2,"path",12),i(),M(),n(3,"p",13),a(4,"\u041D\u0435\u0442 \u0431\u043E\u043D\u0443\u0441\u043E\u0432, \u0438\u0441\u0442\u0435\u043A\u0430\u044E\u0449\u0438\u0445 \u0432 \u0431\u043B\u0438\u0436\u0430\u0439\u0448\u0438\u0435 7 \u0434\u043D\u0435\u0439"),i(),n(5,"a",14),a(6,"\u041D\u0430 \u0433\u043B\u0430\u0432\u043D\u0443\u044E"),i()())}function X(t,s){if(t&1){let e=y();n(0,"app-button",29),v("onClick",function(){b(e);let r=p().$implicit,d=p().$implicit,C=p(3);return E(C.openNotifyModal(d,r))}),_(),n(1,"svg",30),f(2,"path",31)(3,"path",32),i(),a(4," WhatsApp "),i()}}function Y(t,s){t&1&&(n(0,"span",33),a(1,"\u2014"),i())}function q(t,s){if(t&1&&(n(0,"tr")(1,"td"),a(2),i(),n(3,"td")(4,"span",25),a(5),i()(),n(6,"td"),a(7),i(),n(8,"td")(9,"span",26),a(10),i()(),n(11,"td"),c(12,X,5,0,"app-button",27)(13,Y,2,0,"span",28),i()()),t&2){let e=s.$implicit,l=p(4);x("expiring-soon",e.daysLeft<=3)("notified",!!e.notifiedAt),o(2),m(l.formatDate(e.expiryDate)),o(2),x("urgent",e.daysLeft<=3),o(),h("",e.daysLeft," ",l.daysText(e.daysLeft),""),o(2),h("",l.formatAmount(e.totalRemainingAmount)," \u20B8",e.items.length>1?" ("+e.items.length+" \u043D\u0430\u0447\u0438\u0441\u043B.)":"",""),o(2),x("notified",!!e.notifiedAt),o(),m(e.notifiedAt?"\u0423\u0432\u0435\u0434\u043E\u043C\u043B\u0451\u043D":"\u041D\u0443\u0436\u043D\u043E \u0443\u0432\u0435\u0434\u043E\u043C\u0438\u0442\u044C"),o(2),u("ngIf",!e.notifiedAt),o(),u("ngIf",e.notifiedAt)}}function J(t,s){if(t&1&&(n(0,"div",17)(1,"div",18)(2,"div",19)(3,"a",20),a(4),i(),n(5,"span",21),a(6),P(7,"phoneFormat"),i()()(),n(8,"div",22)(9,"table",23)(10,"thead")(11,"tr")(12,"th"),a(13,"\u0418\u0441\u0442\u0435\u043A\u0430\u0435\u0442"),i(),n(14,"th"),a(15,"\u041E\u0441\u0442\u0430\u043B\u043E\u0441\u044C \u0434\u043D\u0435\u0439"),i(),n(16,"th"),a(17,"\u0421\u0443\u043C\u043C\u0430 (\u043E\u0441\u0442\u0430\u0442\u043E\u043A)"),i(),n(18,"th"),a(19,"\u0421\u0442\u0430\u0442\u0443\u0441"),i(),n(20,"th"),a(21,"\u0414\u0435\u0439\u0441\u0442\u0432\u0438\u044F"),i()()(),n(22,"tbody"),c(23,q,14,16,"tr",24),i()()()()),t&2){let e=s.$implicit;o(3),u("routerLink",T(6,U,e.clientId)),o(),m(e.clientName),o(2),m(S(7,4,e.phone)),o(17),u("ngForOf",e.expiryGroups)}}function K(t,s){if(t&1&&(n(0,"div",15),c(1,J,24,8,"div",16),i()),t&2){let e=p(2);o(),u("ngForOf",e.data.clients)}}function Q(t,s){if(t&1&&(n(0,"div"),c(1,j,7,0,"div",8)(2,K,2,1,"div",9),i()),t&2){let e=p();o(),u("ngIf",!e.data||e.data.clients.length===0),o(),u("ngIf",e.data&&e.data.clients.length>0)}}function Z(t,s){if(t&1&&(n(0,"div",44)(1,"label",38),a(2,"\u0428\u0430\u0431\u043B\u043E\u043D \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u044F"),i(),n(3,"div",45)(4,"h4",46),a(5),i(),n(6,"p",47),a(7),i()()()),t&2){let e=p(2);o(5),m(e.selectedTemplate.name),o(2),m(e.selectedTemplate.content)}}function ee(t,s){t&1&&(n(0,"div",48)(1,"span"),a(2,"\u0428\u0430\u0431\u043B\u043E\u043D \u0442\u0438\u043F\u0430 BONUS_EXPIRY \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D. \u0421\u043E\u0437\u0434\u0430\u0439\u0442\u0435 \u0435\u0433\u043E \u0432 \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430\u0445."),i()())}function te(t,s){if(t&1&&(n(0,"div",49)(1,"span",50),a(2),i()()),t&2){let e=p(2);o(2),h("\u0418\u0441\u0442\u0435\u043A\u0430\u0435\u0442 ",e.formatDate(e.selectedGroup.expiryDate)," \xB7 ",e.formatAmount(e.selectedGroup.totalRemainingAmount)," \u20B8")}}function ne(t,s){if(t&1&&(n(0,"div",51)(1,"label",38),a(2,"\u0421\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u043E\u0435 \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u044F"),i(),n(3,"div",52),a(4),i()()),t&2){let e=p(2);o(4),m(e.populatedContent)}}function ie(t,s){if(t&1){let e=y();n(0,"app-button",53),v("click",function(){b(e);let r=p(2);return E(r.sendAndOpenWhatsApp())}),_(),n(1,"svg",30),f(2,"path",31)(3,"path",32),i(),a(4),i()}if(t&2){let e=p(2);u("disabled",e.isSending),o(4),w(" ",e.isSending?"\u041E\u0442\u043F\u0440\u0430\u0432\u043A\u0430...":"\u041E\u0442\u043F\u0440\u0430\u0432\u0438\u0442\u044C \u0432 WhatsApp"," ")}}function oe(t,s){if(t&1&&(n(0,"div",34),c(1,Z,8,2,"div",35)(2,ee,3,0,"div",36),n(3,"div",37)(4,"label",38),a(5,"\u041D\u043E\u043C\u0435\u0440 \u043F\u043E\u043B\u0443\u0447\u0430\u0442\u0435\u043B\u044F"),i(),n(6,"div",39),a(7),P(8,"phoneFormat"),i()(),c(9,te,3,2,"div",40)(10,ne,5,1,"div",41),n(11,"div",42),c(12,ie,5,2,"app-button",43),i()()),t&2){let e=p();o(),u("ngIf",e.selectedTemplate),o(),u("ngIf",!e.selectedTemplate&&!e.loadingTemplate),o(5),m(S(8,6,e.selectedClient.phone)),o(2),u("ngIf",e.selectedGroup),o(),u("ngIf",e.selectedTemplate),o(2),u("ngIf",e.selectedTemplate)}}var be=(()=>{class t{bonusesService=g(V);messageTemplatesService=g(R);messagesService=g(W);toastService=g(F);pageHeaderService=g(z);isLoading=!0;data=null;showNotifyModal=!1;selectedClient=null;selectedGroup=null;selectedTemplate=null;populatedContent="";loadingTemplate=!1;isSending=!1;ngOnInit(){this.pageHeaderService.setPageHeader("\u0411\u043E\u043D\u0443\u0441\u044B \u0438\u0441\u0442\u0435\u043A\u0430\u044E\u0442 \u0441\u043A\u043E\u0440\u043E",[{label:"\u0413\u043B\u0430\u0432\u043D\u0430\u044F",route:"/home"},{label:"\u0411\u043E\u043D\u0443\u0441\u044B \u0438\u0441\u0442\u0435\u043A\u0430\u044E\u0442 \u0441\u043A\u043E\u0440\u043E"}]),this.loadData()}loadData(){this.bonusesService.getBonusesExpiringSoon().subscribe({next:e=>{this.data=e,this.isLoading=!1},error:()=>{this.isLoading=!1}})}formatAmount(e){return typeof e=="number"?e.toLocaleString("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:2}):"0"}formatDate(e){return e?new Date(e).toLocaleDateString("ru-RU",{day:"2-digit",month:"2-digit",year:"numeric"}):"\u2014"}daysText(e){return e===1?"\u0434\u0435\u043D\u044C":e>=2&&e<=4?"\u0434\u043D\u044F":"\u0434\u043D\u0435\u0439"}openNotifyModal(e,l){this.selectedClient=e,this.selectedGroup=l,this.showNotifyModal=!0,this.selectedTemplate=null,this.populatedContent="",this.loadingTemplate=!0,this.messageTemplatesService.getAllTemplates("BONUS_EXPIRY").subscribe({next:r=>{this.loadingTemplate=!1,r&&r.length>0&&(this.selectedTemplate=r[0],this.messageTemplatesService.getPopulatedTemplate("BONUS_EXPIRY",e.clientId,void 0,l.expiryDate).subscribe({next:d=>{this.populatedContent=d.populatedContent},error:()=>{this.populatedContent=this.selectedTemplate?.content??""}}))},error:()=>{this.loadingTemplate=!1}})}closeNotifyModal(){this.showNotifyModal=!1,this.selectedClient=null,this.selectedGroup=null,this.selectedTemplate=null,this.populatedContent="",this.isSending=!1}sendAndOpenWhatsApp(){if(!this.selectedClient||!this.selectedGroup||this.isSending)return;let e=this.populatedContent||this.selectedTemplate?.content||"";if(!e){this.toastService.error("\u041D\u0435\u0442 \u0442\u0435\u043A\u0441\u0442\u0430 \u0441\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u044F");return}this.isSending=!0;let l=this.selectedClient.clientId,r=this.selectedGroup.expiryDate;this.messagesService.sendMessage({clientId:l,messageContent:e,channel:"WHATSAPP"}).subscribe({next:d=>{this.bonusesService.recordBonusExpiryNotified({clientId:l,expiryDate:r,messageRecordId:d.id!=null?Number(d.id):void 0}).subscribe({next:()=>{this.openWhatsAppWeb(this.selectedClient.phone,e),this.toastService.success("\u0421\u043E\u043E\u0431\u0449\u0435\u043D\u0438\u0435 \u0437\u0430\u043F\u0438\u0441\u0430\u043D\u043E, \u043E\u0442\u043A\u0440\u044B\u0432\u0430\u0435\u0442\u0441\u044F WhatsApp"),this.loadData(),this.closeNotifyModal()},error:C=>{this.toastService.error(C.error?.message||"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u043F\u0438\u0441\u0438 \u0443\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u044F")}}),this.isSending=!1},error:d=>{this.toastService.error(d.error?.message||"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0442\u043F\u0440\u0430\u0432\u043A\u0435"),this.isSending=!1}})}openWhatsAppWeb(e,l){let r=e.replace(/[\s\-\(\)\+]/g,"");r.startsWith("8")&&(r="7"+r.substring(1));let d=`https://wa.me/${r}?text=${encodeURIComponent(l)}`;window.open(d,"_blank")}static \u0275fac=function(l){return new(l||t)};static \u0275cmp=O({type:t,selectors:[["app-bonus-expiring-page"]],decls:6,vars:5,consts:[[1,"page-wrapper"],[1,"page-content"],["class","page-loading-container",4,"ngIf"],[4,"ngIf"],["title","\u0423\u0432\u0435\u0434\u043E\u043C\u0438\u0442\u044C \u043E \u0438\u0441\u0442\u0435\u0447\u0435\u043D\u0438\u0438 \u0431\u043E\u043D\u0443\u0441\u043E\u0432",3,"closed","visible","showCloseButton"],["class","notify-content",4,"ngIf"],[1,"page-loading-container"],["type","logo","size","large",3,"visible","overlay"],["class","empty-state",4,"ngIf"],["class","clients-list",4,"ngIf"],[1,"empty-state"],["viewBox","0 0 24 24","fill","none"],["d","M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z","stroke","currentColor","stroke-width","1.5"],[1,"empty-title"],["routerLink","/home",1,"back-link"],[1,"clients-list"],["class","client-block",4,"ngFor","ngForOf"],[1,"client-block"],[1,"client-header"],[1,"client-info"],[1,"client-name",3,"routerLink"],[1,"client-phone"],[1,"groups-table-wrap"],[1,"groups-table"],[3,"expiring-soon","notified",4,"ngFor","ngForOf"],[1,"days-badge"],[1,"status-badge"],["buttonType","primary","size","small",3,"onClick",4,"ngIf"],["class","notified-label",4,"ngIf"],["buttonType","primary","size","small",3,"onClick"],["viewBox","0 0 24 24","fill","none",1,"wa-icon"],["d","M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z","fill","currentColor"],["d","M12 2C6.477 2 2 6.477 2 12c0 1.89.525 3.66 1.438 5.168L2 22l4.832-1.438A9.955 9.955 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2z","fill","currentColor"],[1,"notified-label"],[1,"notify-content"],["class","template-section",4,"ngIf"],["class","template-not-found",4,"ngIf"],[1,"phone-section"],[1,"section-label"],[1,"phone-display"],["class","group-info",4,"ngIf"],["class","message-section",4,"ngIf"],[1,"notify-actions"],["buttonType","primary","size","large","class","send-btn",3,"disabled","click",4,"ngIf"],[1,"template-section"],[1,"template-card"],[1,"template-name"],[1,"template-content"],[1,"template-not-found"],[1,"group-info"],[1,"group-summary"],[1,"message-section"],[1,"message-box"],["buttonType","primary","size","large",1,"send-btn",3,"click","disabled"]],template:function(l,r){l&1&&(n(0,"div",0)(1,"div",1),c(2,$,2,2,"div",2)(3,Q,3,2,"div",3),i()(),n(4,"app-modal",4),v("closed",function(){return r.closeNotifyModal()}),c(5,oe,13,8,"div",5),i()),l&2&&(o(2),u("ngIf",r.isLoading),o(),u("ngIf",!r.isLoading),o(),u("visible",r.showNotifyModal)("showCloseButton",!0),o(),u("ngIf",r.selectedClient&&r.selectedGroup))},dependencies:[D,I,B,A,k,N,L,H,G],styles:[".page-wrapper[_ngcontent-%COMP%]{min-height:100%;margin:-2rem;padding:2rem;background:#f8fafc}.page-content[_ngcontent-%COMP%]{max-width:900px;margin:0 auto}.page-loading-container[_ngcontent-%COMP%]{display:flex;justify-content:center;min-height:40vh;align-items:center}.empty-state[_ngcontent-%COMP%]{text-align:center;padding:4rem 2rem;background:#fff;border-radius:16px;box-shadow:0 1px 3px #0000000f}.empty-state[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:64px;height:64px;color:#94a3b8;margin-bottom:1rem}.empty-title[_ngcontent-%COMP%]{font-size:1.125rem;color:#64748b;margin:0 0 1.5rem}.back-link[_ngcontent-%COMP%]{color:#16a34a;font-weight:600;text-decoration:none}.back-link[_ngcontent-%COMP%]:hover{text-decoration:underline}.clients-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1.5rem}.client-block[_ngcontent-%COMP%]{background:#fff;border-radius:16px;padding:1.25rem;border:1px solid #e2e8f0;box-shadow:0 1px 3px #0000000a}.client-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:.75rem}.client-info[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.client-name[_ngcontent-%COMP%]{font-size:1.125rem;font-weight:600;color:#0f172a;text-decoration:none}.client-name[_ngcontent-%COMP%]:hover{color:#16a34a}.client-phone[_ngcontent-%COMP%]{font-size:.875rem;color:#64748b;font-family:Courier New,monospace}.wa-icon[_ngcontent-%COMP%]{width:18px;height:18px}.groups-table-wrap[_ngcontent-%COMP%]{overflow-x:auto}.groups-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;font-size:.875rem}.groups-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{text-align:left;padding:.75rem;background:#f8fafc;color:#64748b;font-weight:600;border-bottom:1px solid #e2e8f0}.groups-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.75rem;border-bottom:1px solid #f1f5f9}.groups-table[_ngcontent-%COMP%]   tr.expiring-soon[_ngcontent-%COMP%]{background:#fef3c7}.groups-table[_ngcontent-%COMP%]   tr.notified[_ngcontent-%COMP%]{background:#f0fdf4}.days-badge[_ngcontent-%COMP%]{padding:.25rem .5rem;border-radius:8px;background:#dcfce7;color:#166534;font-weight:500}.days-badge.urgent[_ngcontent-%COMP%]{background:#fef3c7;color:#92400e}.status-badge[_ngcontent-%COMP%]{font-size:.8125rem;font-weight:500;color:#92400e}.status-badge.notified[_ngcontent-%COMP%]{color:#166534}.notified-label[_ngcontent-%COMP%]{color:#94a3b8;font-size:.875rem}.notify-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:1.25rem}.section-label[_ngcontent-%COMP%]{font-size:.875rem;font-weight:600;color:#475569;display:block;margin-bottom:.5rem}.template-card[_ngcontent-%COMP%]{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:1rem}.template-name[_ngcontent-%COMP%]{margin:0 0 .5rem;font-size:1rem;font-weight:600;color:#1f2937}.template-content[_ngcontent-%COMP%]{margin:0;font-size:.9375rem;color:#475569;white-space:pre-wrap}.template-not-found[_ngcontent-%COMP%]{padding:1rem;background:#fef3c7;border-radius:12px;color:#92400e;font-size:.875rem}.phone-display[_ngcontent-%COMP%]{padding:.75rem 1rem;background:#f8fafc;border-radius:10px;font-family:Courier New,monospace;font-weight:500}.group-info[_ngcontent-%COMP%]{padding:.5rem 0}.group-summary[_ngcontent-%COMP%]{font-size:.875rem;color:#64748b}.message-box[_ngcontent-%COMP%]{padding:1rem;background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;font-size:.9375rem;white-space:pre-wrap;max-height:200px;overflow-y:auto}.notify-actions[_ngcontent-%COMP%]{margin-top:.5rem}.send-btn[_ngcontent-%COMP%]{width:100%}.send-btn[_ngcontent-%COMP%]     button{width:100%;justify-content:center}"]})}return t})();export{be as BonusExpiringPageComponent};
