{
  "version": 3,
  "sources": ["src/app/core/services/bonuses.service.ts"],
  "sourcesContent": ["import { Injectable } from '@angular/core';\nimport { HttpClient, HttpParams } from '@angular/common/http';\nimport { Observable } from 'rxjs';\nimport { map } from 'rxjs/operators';\nimport { environment } from '../../../environments/environment';\n\nexport interface BonusHistoryItem {\n  id: number;\n  eventId: string | null;\n  clientId: string;\n  clientName: string;\n  eventType: 'GRANTED' | 'USED' | 'EXPIRED' | 'REVOKED' | 'MANUAL_REVOKE';\n  bonusAmount: number;\n  createdAt: string;\n  /** For GRANTED: original grant amount */\n  originalAmount?: number | null;\n  /** For GRANTED: remaining after consumptions */\n  remainingAmount?: number | null;\n  paymentTxId: string | null;\n  bonusPercentage: number | null;\n  paymentAmount: number | null;\n  grantReason: string | null;\n  expiresAt: string | null;\n  originalPaymentAmount: number | null;\n  finalPaymentAmount: number | null;\n  revokeReason: string | null;\n  originalPaymentTxId: string | null;\n  refundTxId: string | null;\n  revokedAt: string | null;\n  /** For MANUAL_REVOKE: who performed the revoke */\n  revokedByUserId?: number | null;\n  revokedByUserName?: string | null;\n  /** Initiator for any event: who performed the action */\n  initiatedByUserId?: number | null;\n  initiatedByUserName?: string | null;\n}\n\nexport interface BonusHistoryResponse {\n  content: BonusHistoryItem[];\n  page: number;\n  size: number;\n  totalElements: number;\n  totalPages: number;\n  first: boolean;\n  last: boolean;\n}\n\nexport interface BonusBalance {\n  clientId: string;\n  clientName: string;\n  totalAccumulated: number;\n  totalUsed: number;\n  currentBalance: number;\n}\n\nexport interface ManualBonusGrantRequest {\n  amount: number;\n  reason?: string;\n}\n\nexport interface ManualBonusRevokeRequest {\n  amount: number;\n  reason?: string;\n}\n\nexport interface BonusExpiringItem {\n  grantId: number;\n  remainingAmount: number;\n  originalAmount: number;\n  expiresAt: string;\n  daysLeft: number;\n  grantReason: string | null;\n}\n\n/** One row per expiry date: grouped amount and notified status */\nexport interface ExpiryGroup {\n  expiryDate: string; // YYYY-MM-DD\n  daysLeft: number;\n  totalRemainingAmount: number;\n  notifiedAt: string | null; // ISO timestamp when WhatsApp was sent; null if not yet notified\n  items: BonusExpiringItem[];\n}\n\nexport interface ClientBonusExpiring {\n  clientId: string;\n  clientName: string;\n  phone: string;\n  expiryGroups: ExpiryGroup[];\n}\n\nexport interface RecordBonusExpiryNotifiedRequest {\n  clientId: string;\n  expiryDate: string; // YYYY-MM-DD\n  messageRecordId?: number | null;\n}\n\nexport interface BonusesExpiringSoon {\n  clientCount: number;\n  totalAmount: number;\n  clients: ClientBonusExpiring[];\n}\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class BonusesService {\n  private readonly apiUrl = `${environment.apiUrl}/bonuses`;\n\n  constructor(private http: HttpClient) {}\n\n  /**\n   * Get clients whose bonuses expire within 7 days (summary + list)\n   */\n  getBonusesExpiringSoon(): Observable<BonusesExpiringSoon> {\n    return this.http.get<BonusesExpiringSoon>(`${this.apiUrl}/expiring-soon`);\n  }\n\n  /**\n   * Record that the client was notified (WhatsApp) about bonuses expiring on the given date.\n   */\n  recordBonusExpiryNotified(request: RecordBonusExpiryNotifiedRequest): Observable<void> {\n    return this.http.post(`${this.apiUrl}/expiring-soon/notified`, request, { responseType: 'text' }).pipe(\n      map(() => undefined)\n    );\n  }\n\n  /**\n   * Get client bonus history with pagination\n   */\n  getClientBonusHistory(clientId: string, page: number = 0, size: number = 100): Observable<BonusHistoryResponse> {\n    const params = new HttpParams()\n      .set('page', page.toString())\n      .set('size', size.toString());\n    return this.http.get<BonusHistoryResponse>(`${this.apiUrl}/client/${clientId}/history`, { params });\n  }\n\n  /**\n   * Get client bonus balance\n   */\n  getClientBonusBalance(clientId: string): Observable<BonusBalance> {\n    return this.http.get<BonusBalance>(`${this.apiUrl}/client/${clientId}/balance`);\n  }\n\n  /**\n   * Manually grant bonus to a client\n   */\n  grantBonus(clientId: string, request: ManualBonusGrantRequest): Observable<BonusBalance> {\n    return this.http.post<BonusBalance>(`${this.apiUrl}/client/${clientId}/grant`, request);\n  }\n\n  /**\n   * Manually revoke bonus from a client\n   */\n  revokeBonus(clientId: string, request: ManualBonusRevokeRequest): Observable<BonusBalance> {\n    return this.http.post<BonusBalance>(`${this.apiUrl}/client/${clientId}/revoke`, request);\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;AAyGM,IAAO,iBAAP,MAAO,gBAAc;EAGL;EAFH,SAAS,GAAG,YAAY,MAAM;EAE/C,YAAoB,MAAgB;AAAhB,SAAA,OAAA;EAAmB;;;;EAKvC,yBAAsB;AACpB,WAAO,KAAK,KAAK,IAAyB,GAAG,KAAK,MAAM,gBAAgB;EAC1E;;;;EAKA,0BAA0B,SAAyC;AACjE,WAAO,KAAK,KAAK,KAAK,GAAG,KAAK,MAAM,2BAA2B,SAAS,EAAE,cAAc,OAAM,CAAE,EAAE,KAChG,IAAI,MAAM,MAAS,CAAC;EAExB;;;;EAKA,sBAAsB,UAAkB,OAAe,GAAG,OAAe,KAAG;AAC1E,UAAM,SAAS,IAAI,WAAU,EAC1B,IAAI,QAAQ,KAAK,SAAQ,CAAE,EAC3B,IAAI,QAAQ,KAAK,SAAQ,CAAE;AAC9B,WAAO,KAAK,KAAK,IAA0B,GAAG,KAAK,MAAM,WAAW,QAAQ,YAAY,EAAE,OAAM,CAAE;EACpG;;;;EAKA,sBAAsB,UAAgB;AACpC,WAAO,KAAK,KAAK,IAAkB,GAAG,KAAK,MAAM,WAAW,QAAQ,UAAU;EAChF;;;;EAKA,WAAW,UAAkB,SAAgC;AAC3D,WAAO,KAAK,KAAK,KAAmB,GAAG,KAAK,MAAM,WAAW,QAAQ,UAAU,OAAO;EACxF;;;;EAKA,YAAY,UAAkB,SAAiC;AAC7D,WAAO,KAAK,KAAK,KAAmB,GAAG,KAAK,MAAM,WAAW,QAAQ,WAAW,OAAO;EACzF;;qCAlDW,iBAAc,mBAAA,UAAA,CAAA;EAAA;4EAAd,iBAAc,SAAd,gBAAc,WAAA,YAFb,OAAM,CAAA;;;sEAEP,gBAAc,CAAA;UAH1B;WAAW;MACV,YAAY;KACb;;;",
  "names": []
}
